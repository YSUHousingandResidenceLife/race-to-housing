<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Race to Housing â€” Live Board + Route</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root{ --card-bg:rgba(255,255,255,.96); --card-border:#e5e5e5; --accent:#d6001c; --muted:#6b7280; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{position:absolute;inset:0}

    /* Panels */
    .panel{position:absolute;top:12px;z-index:20;width:360px;background:var(--card-bg);
      border:1px solid var(--card-border);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.1);
      overflow:hidden;display:flex;flex-direction:column}
    .panel.instructions{left:12px} .panel.players{right:12px}
    .panel header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--card-border);background:#fff}
    .panel header h3{margin:0;font-size:16px}
    .panel header button{border:1px solid var(--card-border);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .panel .content{padding:12px 14px;max-height:48vh;overflow:auto}

    /* Instructions */
    .steps{display:grid;gap:10px}
    .step{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:flex-start;background:#fff;border:1px solid var(--card-border);border-radius:10px;padding:10px}
    .step .num{width:26px;height:26px;border-radius:50%;background:var(--accent);color:#fff;display:grid;place-items:center;font-weight:700;font-size:13px}

    /* Players */
    .players .content{display:grid;gap:8px}
    .player{display:grid;grid-template-columns:28px 1fr auto;align-items:center;gap:10px;background:#fff;border:1px solid var(--card-border);border-radius:10px;padding:8px 10px}
    .token{width:24px;height:24px;border-radius:6px;border:1px solid rgba(0,0,0,.1);background:#222}
    .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .score{color:var(--muted);font-size:13px}

    /* Responsive */
    @media (max-width:960px){
      .panel{width:min(92vw,380px)}
      .panel.instructions{left:8px}
      .panel.players{right:8px}
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Instructions -->
  <section class="panel instructions" id="instructionsPanel">
    <header>
      <h3>Race to Housing â€” How to Play</h3>
      <button type="button" data-toggle="#instructionsPanel">Hide</button>
    </header>
    <div class="content">
      <div class="steps">
        <div class="step"><div class="num">1</div><div>Pick a team token. Everyone starts at <b>Lyden</b>.</div></div>
        <div class="step"><div class="num">2</div><div>Spin / roll and follow the red route tiles.</div></div>
        <div class="step"><div class="num">3</div><div>Complete building challenges to earn points and move.</div></div>
        <div class="step"><div class="num">4</div><div>Reach <b>Kilcawley</b> first with required points to win.</div></div>
      </div>
    </div>
  </section>

  <!-- Players (live from Firestore) -->
  <section class="panel players" id="playersPanel">
    <header>
      <h3>Players Board</h3>
      <button type="button" data-toggle="#playersPanel">Hide</button>
    </header>
    <div class="content">
      <div id="playersList"></div>
      <div class="meta" id="playersMeta">Loading playersâ€¦</div>
    </div>
  </section>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script type="module">
    /************ MAP ************/
    const STYLE_ID = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
    const GEOJSON_URL = encodeURI('ysu_race_buildings_exact final.geojson'); // same folder
    const CAMPUS_BOUNDS = [[-80.6570, 41.1026], [-80.6415, 41.1120]];
    const PITCH = 60, BEARING = -133.6;

    mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_ID,
      center: [-80.6458, 41.1090],   // temporary center; we'll fit to buildings
      zoom: 16.8,
      pitch: PITCH,
      bearing: BEARING,
      minZoom: 15,
      maxZoom: 19,
      maxBounds: CAMPUS_BOUNDS
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    function hideLabelsAndBaseBuildings() {
      const layers = map.getStyle().layers || [];
      for (const lyr of layers) {
        if (lyr.type === 'symbol' || /label/i.test(lyr.id)) {
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }
      for (const lyr of layers) {
        if (/building/i.test(lyr.id) && (lyr.type === 'fill-extrusion' || lyr.type === 'fill')) {
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }
    }
    async function loadJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`Failed to load ${url}`); return r.json(); }
    function bboxFromFeatures(fc){
      let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
      for(const f of fc.features||[]){ const g=f.geometry; if(!g) continue;
        const polys=g.type==='Polygon'?[g.coordinates]:g.type==='MultiPolygon'?g.coordinates:[];
        for(const poly of polys) for(const ring of poly) for(const [x,y] of ring){
          if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y;
        }}
      return [[minX,minY],[maxX,maxY]];
    }

    // --- Route GeoJSON (approximate waypoints through your six buildings) ---
    const ROUTE = {
      "type":"FeatureCollection",
      "features":[
        {
          "type":"Feature",
          "properties":{"name":"Race Route"},
          "geometry":{
            "type":"LineString",
            "coordinates":[
              [-80.647458, 41.111143],                          /* Lyden */
              [-80.64698, 41.11098],
              [-80.6461376731338, 41.11100745921387],           /* Cafaro */
              [-80.64675, 41.11078],
              [-80.64724052183561, 41.110525670257104],         /* Christman */
              [-80.64655, 41.10990],
              [-80.64590, 41.10920],
              [-80.64540, 41.10860],
              [-80.64483333333334, 41.10769444444445],          /* Weller */
              [-80.64455, 41.10759],
              [-80.64426251711262, 41.107489184836176],         /* Wick */
              [-80.64505, 41.10725],
              [-80.64600, 41.10695],
              [-80.64731987291158, 41.10673909169142]           /* Kilcawley */
            ]
          }
        }
      ]
    };

    // dashed â€œtilesâ€ animation sequence (Mapbox demo style)
    const dashSeq = [
      [0, 4, 3, 4],
      [1, 4, 2, 4],
      [2, 4, 1, 4],
      [3, 4, 0, 4],
      [4, 4, 0, 4],
      [3, 4, 1, 4],
      [2, 4, 2, 4],
      [1, 4, 3, 4]
    ];
    let dashIndex = 0;

    map.on('load', async () => {
      hideLabelsAndBaseBuildings();
      const data = await loadJSON(GEOJSON_URL);

      // Buildings
      map.addSource('race-buildings-src', { type:'geojson', data, generateId:true });
      map.addLayer({
        id:'race-buildings', type:'fill-extrusion', source:'race-buildings-src',
        paint:{
          'fill-extrusion-color':['coalesce',['get','fill'],'#d6001c'],
          'fill-extrusion-height':['coalesce',['get','height'],22],
          'fill-extrusion-opacity':0.96
        }
      });

      // Route sources
      map.addSource('race-route', { type:'geojson', data: ROUTE });

      // Base red track
      map.addLayer({
        id:'route-track',
        type:'line',
        source:'race-route',
        paint:{
          'line-color':'#D62D20',
          'line-width': 16,
          'line-opacity': 0.95,
          'line-cap':'round',
          'line-join':'round'
        }
      });

      // â€œPlank stepsâ€ (static dots on top)
      map.addLayer({
        id:'route-steps',
        type:'line',
        source:'race-route',
        paint:{
          'line-color':'#9C1A13',
          'line-width': 16,
          'line-cap':'round',
          'line-join':'round',
          // dash creates spaced round caps that read like tiles
          'line-dasharray':[0, 2, 1.2, 2]
        }
      });

      // Animated moving lights (golden dots)
      map.addLayer({
        id:'route-lights',
        type:'line',
        source:'race-route',
        paint:{
          'line-color':'#FFD54A',
          'line-width': 8,
          'line-cap':'round',
          'line-join':'round',
          'line-dasharray': dashSeq[0]
        }
      });

      // Animate the lights
      function animateLights(){
        dashIndex = (dashIndex + 1) % dashSeq.length;
        map.setPaintProperty('route-lights','line-dasharray', dashSeq[dashIndex]);
        requestAnimationFrame(animateLights);
      }
      animateLights();

      // Fit to all buildings, then nudge ~0.6 zoom closer
      const bounds = bboxFromFeatures(data);
      map.fitBounds(bounds, {
        padding:{ top:80, right:160, bottom:120, left:320 },
        maxZoom:18, pitch:PITCH, bearing:BEARING, duration:500
      });
      map.once('moveend', ()=> map.zoomTo(map.getZoom()+0.6,{duration:500}));
    });

    // Panel toggles
    document.querySelectorAll('[data-toggle]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const panel = document.querySelector(btn.getAttribute('data-toggle'));
        const content = panel.querySelector('.content');
        const hidden = content.style.display==='none';
        content.style.display = hidden ? '' : 'none';
        btn.textContent = hidden ? 'Hide' : 'Show';
      });
    });

    /************ FIRESTORE (read-only board) ************/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB6Yg6UMpfIjlKAqyV50egsXnlnWY1RyBM",
      authDomain: "race-to-housing.firebaseapp.com",
      projectId: "race-to-housing",
      storageBucket: "race-to-housing.firebasestorage.app",
      messagingSenderId: "569695954799",
      appId: "1:569695954799:web:93f20901d27bebaeadaa9a",
      measurementId: "G-VQKHZ1ZTWE"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);

    const playersEl = document.getElementById('playersList');
    const metaEl = document.getElementById('playersMeta');

    const q = query(
      collection(db, 'players'),
      where('active', '==', true),
      orderBy('points', 'desc'),
      orderBy('name', 'asc'),
      limit(350)
    );

    onSnapshot(q, (snap) => {
      const frag = document.createDocumentFragment();
      let count = 0;

      snap.forEach((doc, idx) => {
        const p = doc.data();
        const row = document.createElement('div');
        row.className = 'player';

        // neutral token (no color)
        const token = document.createElement('div');
        token.className = 'token';

        // crown for #1
        if (idx === 0) {
          token.style.position = "relative";
          const crown = document.createElement('span');
          crown.textContent = "ðŸ‘‘";
          crown.style.position = "absolute";
          crown.style.top = "-10px";
          crown.style.right = "-10px";
          crown.style.fontSize = "18px";
          row.style.fontWeight = "700";
          token.appendChild(crown);
        }

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = p.name || '(unnamed)';

        const score = document.createElement('div');
        score.className = 'score';
        score.textContent = `Pts: ${Number(p.points || 0)}`;

        row.append(token, name, score);
        frag.append(row);
        count++;
      });

      playersEl.replaceChildren(frag);
      metaEl.textContent = `${count} active player${count===1?'':'s'}`;
    });
  </script>
</body>
</html>
