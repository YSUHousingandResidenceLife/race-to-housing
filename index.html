<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Race to Housing â€” Autoâ€‘Capture (7/7) Buildings</title>
Â  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
Â  <style>
Â  Â  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
Â  Â  #app { display:grid; grid-template-rows:auto 1fr; height:100%; }
Â  Â  header { display:flex; gap:12px; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb; background:#fff; position:sticky; top:0; z-index:2; }
Â  Â  .badge { padding:4px 8px; border-radius:999px; background:#f3f4f6; font-weight:600; }
Â  Â  #status { font-variant-numeric: tabular-nums; }
Â  Â  .controls { margin-left:auto; display:flex; gap:8px; }
Â  Â  button { border:1px solid #d1d5db; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; }
Â  Â  button[disabled] { opacity:.5; cursor:not-allowed; }
Â  Â  .note { font-size:12px; color:#6b7280; }
Â  Â  #map { position:relative; }
Â  Â  #map, #map canvas { width:100%; height:100%; display:block; }
Â  Â  .toast { position:absolute; left:12px; bottom:12px; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; box-shadow:0 8px 20px rgba(0,0,0,.2); z-index:3; }
Â  </style>
</head>
<body>
<div id="app">
Â  <header>
Â  Â  <span class="badge">YSU â€” Autoâ€‘Capture</span>
Â  Â  <strong id="status">0/7 captured</strong>
Â  Â  <span class="note">(Hardâ€‘coded token. Autoâ€‘captures all 7 buildings including University Courtyards.)</span>
Â  Â  <div class="controls">
Â  Â  Â  <button id="startBtn">Start Autoâ€‘Capture</button>
Â  Â  Â  <button id="downloadBtn" disabled>Download ysu_race_buildings_exact.geojson</button>
Â  Â  </div>
Â  </header>

Â  <details id="tuner" open style="border-bottom:1px solid #e5e7eb;background:#fafafa;padding:8px 12px;font:12px/1.35 system-ui, -apple-system, Segoe UI;">
Â  Â  <summary><strong>Capture tuner</strong> <span style="color:#6b7280">Adjust centers if a building isnâ€™t found</span></summary>
Â  Â  <div id="centerList"></div>
Â  Â  <div style="margin-top:6px;color:#6b7280">Tip: Pan the map so the crosshair (center) sits on the building, then click <em>Set to map center</em>.</div>
Â  </details>

Â  <div id="map"></div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
// ===== CONFIG =====
// ðŸ”’ Hardâ€‘code your working token here per your request
mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

const STYLE = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
const INITIAL_VIEW = { center: [-80.644685, 41.107524], zoom: 17.2, pitch: 60, bearing: -133.6 };

// All 7 building centers (includes University Courtyards)
// --- UPDATED COORDINATES FOR BETTER CAPTURE ---
let DEFAULT_BUILDING_CENTERS = [
Â  { key:'lyden',Â  Â  Â  name:'Lyden House',Â  Â  Â  Â  Â  Â  Â  Â  Â lng:-80.647900, lat:41.107000 },
Â  { key:'cafaro',Â  Â  Â name:'Cafaro House (incl. Annex)',Â  lng:-80.648900, lat:41.107500 },
Â  { key:'christman',Â  name:'Christman Dining',Â  Â  Â  Â  Â  Â  lng:-80.646800, lat:41.106800 }, // Based on 41.1068, -80.6468
Â  { key:'weller',Â  Â  Â name:'Weller House',Â  Â  Â  Â  Â  Â  Â  Â  lng:-80.645000, lat:41.108400 }, // Based on 41.11, -80.64
Â  { key:'wick',Â  Â  Â  Â name:'Wick House',Â  Â  Â  Â  Â  Â  Â  Â  Â  lng:-80.645500, lat:41.108500 }, // Based on 41.11, -80.64
Â  { key:'kilcawley',Â  name:'Kilcawley Center',Â  Â  Â  Â  Â  Â  Â lng:-80.646200, lat:41.106500 },
Â  { key:'courtyards', name:'University Courtyards',Â  Â  Â  Â lng:-80.642689, lat:41.105327 } // Custom coordinate
];
// ---------------------------------------------

function loadCenters(){
Â  try{ const s = localStorage.getItem('YSU_CAPTURE_CENTERS'); if(s){
Â  Â  const saved = JSON.parse(s); return DEFAULT_BUILDING_CENTERS.map(d=> saved[d.key] ? { ...d, ...saved[d.key] } : d);
Â  }}catch(_){}
Â  return [...DEFAULT_BUILDING_CENTERS];
}
function saveCenter(key, lng, lat){
Â  try{
Â  Â  const cur = JSON.parse(localStorage.getItem('YSU_CAPTURE_CENTERS')||'{}');
Â  Â  cur[key] = { lng, lat };
Â  Â  localStorage.setItem('YSU_CAPTURE_CENTERS', JSON.stringify(cur));
Â  }catch(_){ /* ignore */ }
}
let BUILDING_CENTERS = loadCenters();

let map = new mapboxgl.Map({ container:'map', style:STYLE, ...INITIAL_VIEW });
map.addControl(new mapboxgl.NavigationControl({ showZoom:true }), 'top-right');

let candidateLayers = [];
let captured = [];
let debugBoxId = 'search-box', debugBoxLayer = 'search-box-fill', debugOutlineLayer = 'search-box-outline';

const startBtn = document.getElementById('startBtn');
const downloadBtn = document.getElementById('downloadBtn');
const statusEl = document.getElementById('status');
const toastEl = document.getElementById('toast');

function toast(msg, ms=1800){
Â  toastEl.textContent = msg; toastEl.style.display='block';
Â  clearTimeout(toastEl._t); toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
}

const BUILDING_LAYER_PREDICATE = (layer) => {
Â  if (!layer) return false;
Â  const tid = String(layer.id || '').toLowerCase();
Â  return (layer.type === 'fill' || layer.type === 'fill-extrusion') &&
Â  Â  Â  Â  Â (tid.includes('building') || tid.includes('bldg'));
};

function metersToPixelsAtLat(meters, lat, zoom){
Â  const earthCircumference = 40075017; // meters
Â  const latRad = lat * Math.PI / 180;
Â  return meters / (earthCircumference * Math.cos(latRad) / Math.pow(2, zoom));
}

function bboxAround([lng,lat], meters, z){
Â  const px = metersToPixelsAtLat(meters, lat, z);
Â  const p1 = map.project([lng, lat]);
Â  const min = [p1.x - px, p1.y + px];
Â  const max = [p1.x + px, p1.y - px];
Â  const sw = map.unproject(min), ne = map.unproject(max);
Â  // draw debug box polygon
Â  try{
Â  Â  const poly = { type:'Feature', geometry:{ type:'Polygon', coordinates:[[
Â  Â  Â  [sw.lng, sw.lat],[ne.lng, sw.lat],[ne.lng, ne.lat],[sw.lng, ne.lat],[sw.lng, sw.lat]
Â  Â  ]]}};
Â  Â  if(!map.getSource(debugBoxId)){
Â  Â  Â  map.addSource(debugBoxId,{ type:'geojson', data:poly });
Â  Â  Â  map.addLayer({ id:debugBoxLayer, type:'fill', source:debugBoxId, paint:{ 'fill-opacity':0.07 } });
Â  Â  Â  map.addLayer({ id:debugOutlineLayer, type:'line', source:debugBoxId, paint:{ 'line-width':1 } });
Â  Â  } else { map.getSource(debugBoxId).setData(poly); }
Â  }catch(_){ }
Â  return [sw.lng, sw.lat, ne.lng, ne.lat];
}

function layerIds(){
Â  return candidateLayers.length ? candidateLayers : (candidateLayers = (map.getStyle().layers || []).filter(BUILDING_LAYER_PREDICATE).map(l=>l.id));
}

function queryBuildingsInBox(box){
Â  let features = [];
Â  try{
Â  Â  // Preferred: query only likely building layers
Â  Â  const layers = layerIds();
Â  Â  features = map.queryRenderedFeatures(box, { layers });
Â  Â  features = features.filter(f => f.geometry && (f.geometry.type==='Polygon'||f.geometry.type==='MultiPolygon'));
Â  Â  if (features.length) return features;
Â  }catch(_){ }
Â  // Fallback: query all rendered features, then filter polygons
Â  try{
Â  Â  const all = map.queryRenderedFeatures(box);
Â  Â  return all.filter(f => f.geometry && (f.geometry.type==='Polygon'||f.geometry.type==='MultiPolygon'));
Â  }catch(_){ return []; }
}

function dissolve(features){
Â  if (!features.length) return null;
Â  let fc = turf.featureCollection(features.map(f => turf.clone(f)));
Â  try {
Â  Â  let u = fc.features[0];
Â  Â  for (let i=1; i<fc.features.length; i++) u = turf.union(u, fc.features[i]);
Â  Â  return u;
Â  } catch(e){
Â  Â  return turf.combine(fc);
Â  }
}

async function flyAndIdle(opts){
Â  return new Promise(resolve => {
Â  Â  const done = ()=>{ map.off('idle', done); resolve(); };
Â  Â  map.once('idle', done);
Â  Â  map.flyTo({ ...opts, duration:700 });
Â  });
}

async function captureOne(target, attempt=1){
Â  const maxAttempts = 6; // widen more aggressively
Â  const radii = [28, 42, 60, 85, 120, 160];
Â  const radius = radii[Math.min(attempt-1, radii.length-1)];
Â  await flyAndIdle({ center:[target.lng, target.lat], zoom: Math.max(INITIAL_VIEW.zoom, 17.2), pitch: INITIAL_VIEW.pitch, bearing: INITIAL_VIEW.bearing });
Â  const box = bboxAround([target.lng, target.lat], radius, map.getZoom());
Â  const feats = queryBuildingsInBox(box);

Â  if (!feats.length){
Â  Â  if (attempt < maxAttempts){
Â  Â  Â  toast(`No features at ${target.name} (try ${attempt+1}/${maxAttempts}) â€” widening searchâ€¦`);
Â  Â  Â  return captureOne(target, attempt+1);
Â  Â  }
Â  Â  throw new Error(`No building polygons found for ${target.name}. Tip: use the tuner to set this center to the building and rerun.`);
Â  }

Â  const merged = dissolve(feats);
Â  if (!merged) throw new Error(`Could not merge features for ${target.name}.`);

Â  const fixed = turf.truncate(merged, { precision: 6, coordinates: 3 });
Â  fixed.properties = { name: target.name, key: target.key };
Â  return fixed;
}

function updateStatus(){
Â  statusEl.textContent = `${captured.length}/7 captured`;
Â  if (captured.length === BUILDING_CENTERS.length){
Â  Â  downloadBtn.disabled = false;
Â  Â  toast('All 7 captured â€” ready to download');
Â  }
}

function downloadGeoJSON(){
Â  const fc = { type:'FeatureCollection', features: captured };
Â  const blob = new Blob([JSON.stringify(fc, null, 2)], { type:'application/json' });
Â  const url = URL.createObjectURL(blob);
Â  const a = document.createElement('a');
Â  a.href = url; a.download = 'ysu_race_buildings_exact.geojson';
Â  document.body.appendChild(a); a.click(); a.remove();
Â  setTimeout(()=> URL.revokeObjectURL(url), 2000);
}

downloadBtn.addEventListener('click', downloadGeoJSON);

async function runAutoCapture(){
Â  startBtn.disabled = true; downloadBtn.disabled = true; captured = []; updateStatus();
Â  toast('Starting autoâ€‘captureâ€¦');
Â  // refresh working centers in case user tuned some
Â  BUILDING_CENTERS = loadCenters();

Â  for (const target of BUILDING_CENTERS){
Â  Â  try {
Â  Â  Â  const feat = await captureOne(target);
Â  Â  Â  captured.push(feat);
Â  Â  Â  updateStatus();
Â  Â  } catch(e){
Â  Â  Â  console.error(e);
Â  Â  Â  toast(e.message, 2400);
Â  Â  }
Â  }

Â  if (captured.length < BUILDING_CENTERS.length){
Â  Â  toast(`Captured ${captured.length}/7. Adjust centers if needed and run again.` , 2600);
Â  Â  startBtn.disabled = false;
Â  Â  return;
Â  }

Â  try {
Â  Â  const fc = { type:'FeatureCollection', features: captured };
Â  Â  if (!map.getSource('captured')){
Â  Â  Â  map.addSource('captured', { type:'geojson', data: fc });
Â  Â  Â  map.addLayer({ id:'captured-fill', type:'fill', source:'captured', paint:{ 'fill-opacity': 0.35 } });
Â  Â  Â  map.addLayer({ id:'captured-outline', type:'line', source:'captured', paint:{ 'line-width': 2 } });
Â  Â  Â  map.addLayer({ id:'captured-labels', type:'symbol', source:'captured', layout:{ 'text-field':['get','name'], 'text-size': 12, 'text-offset':[0, 1.2] }, paint:{ 'text-halo-width':1, 'text-halo-color':'#ffffff' } });
Â  Â  } else {
Â  Â  Â  map.getSource('captured').setData(fc);
Â  Â  }
Â  } catch(e){ console.warn('Render overlay failed', e); }

Â  updateStatus();
}

startBtn.addEventListener('click', runAutoCapture);

map.on('load', ()=>{
Â  candidateLayers = (map.getStyle().layers || []).filter(BUILDING_LAYER_PREDICATE).map(l=>l.id);
Â  if (!candidateLayers.length){ toast('No obvious building layers found in style. Will still try a broad search.'); }
Â  buildCenterUI();
});

// ---------- Center Tuner UI ----------
function buildCenterUI(){
Â  const wrap = document.getElementById('centerList');
Â  if (!wrap) return;
Â  const rows = BUILDING_CENTERS.map(b=>{
Â  Â  return `<div style="display:flex;gap:8px;align-items:center;margin:4px 0;">
Â  Â  Â  <code style="min-width:160px;display:inline-block">${b.name}</code>
Â  Â  Â  <span style="color:#6b7280">lng:</span><span id="lng-${b.key}">${b.lng.toFixed(6)}</span>
Â  Â  Â  <span style="color:#6b7280">lat:</span><span id="lat-${b.key}">${b.lat.toFixed(6)}</span>
Â  Â  Â  <button data-key="${b.key}" class="set-center" style="margin-left:8px;">Set to map center</button>
Â  Â  Â  <button data-key="${b.key}" class="try-capture" title="Test only this building (preview)">Test</button>
Â  Â  </div>`;
Â  }).join('');
Â  wrap.innerHTML = rows;
Â  wrap.querySelectorAll('.set-center').forEach(btn=>{
Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  const key = btn.getAttribute('data-key');
Â  Â  Â  const c = map.getCenter(); saveCenter(key, c.lng, c.lat);
Â  Â  Â  BUILDING_CENTERS = loadCenters();
Â  Â  Â  const cur = BUILDING_CENTERS.find(x=>x.key===key);
Â  Â  Â  document.getElementById(`lng-${key}`).textContent = cur.lng.toFixed(6);
Â  Â  Â  document.getElementById(`lat-${key}`).textContent = cur.lat.toFixed(6);
Â  Â  Â  toast(`${cur.name} center updated.`);
Â  Â  });
Â  });
Â  wrap.querySelectorAll('.try-capture').forEach(btn=>{
Â  Â  btn.addEventListener('click', async ()=>{
Â  Â  Â  const key = btn.getAttribute('data-key');
Â  Â  Â  const tgt = BUILDING_CENTERS.find(x=>x.key===key);
Â  Â  Â  try{
Â  Â  Â  Â  const feat = await captureOne(tgt);
Â  Â  Â  Â  // preview only
Â  Â  Â  Â  const srcId = `preview-${key}`;
Â  Â  Â  Â  if(!map.getSource(srcId)){
Â  Â  Â  Â  Â  map.addSource(srcId, { type:'geojson', data: feat });
Â  Â  Â  Â  Â  map.addLayer({ id:`${srcId}-fill`, type:'fill', source:srcId, paint:{ 'fill-opacity':0.25 } });
Â  Â  Â  Â  Â  map.addLayer({ id:`${srcId}-line`, type:'line', source:srcId, paint:{ 'line-width':2 } });
Â  Â  Â  Â  } else { map.getSource(srcId).setData(feat); }
Â  Â  Â  Â  toast(`Preview ok for ${tgt.name}`);
Â  Â  Â  }catch(e){ toast(e.message, 2600); }
Â  Â  });
Â  });
}
</script>
</body>
</html>
