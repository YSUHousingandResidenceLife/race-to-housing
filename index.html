<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Race to Housing â€” Exact Building Shapes</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }
    .toolbar{position:absolute;top:12px;left:12px;z-index:10;display:flex;gap:8px}
    .btn{background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px 12px;font:14px system-ui;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.1)}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <button id="downloadBtn" class="btn">Download buildings (.geojson)</button>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const STYLE = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
    const campusBounds = [[-80.6570, 41.1026], [-80.6415, 41.1120]];

    // Buildings to capture (added University Courtyards)
    const TARGETS = [
      {name:'Lyden House',              color:'#FFD94A', coord:[-80.647458, 41.111143]},
      {name:'Cafaro House',             color:'#FF8A00', coord:[-80.6461376731338, 41.11100745921387]},
      {name:'Christman Dining',         color:'#808000', coord:[-80.64724052183561, 41.110525670257104]},
      {name:'Weller House',             color:'#00FFFF', coord:[-80.64483333333334, 41.10769444444445]},
      {name:'Wick House (Art)',         color:'#B67BFF', coord:[-80.64426251711262, 41.107489184836176]},
      {name:'Kilcawley House',          color:'#00A651', coord:[-80.64731987291158, 41.10673909169142]},
      {name:'University Courtyards',    color:'#FF3D71', coord:[-80.64555, 41.10690]} // NEW
    ];

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE,
      center: [-80.644685, 41.107524],
      zoom: 17.2,
      pitch: 60,
      bearing: -133.6,
      maxBounds: campusBounds,
      minZoom: 15,
      maxZoom: 19
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // Utility: download JSON
    function downloadJSON(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // Find a building polygon near a screen point (tries a few window sizes)
    function getFootprintAt(pointPx){
      const paddings = [14, 18, 22, 26];
      for (const padding of paddings) {
        const bbox = [
          [pointPx.x - padding, pointPx.y - padding],
          [pointPx.x + padding, pointPx.y + padding]
        ];
        const feats = map.queryRenderedFeatures(bbox);
        // pick the largest polygon from any layer that looks like a building
        let best = null, bestArea = 0;
        for (const f of feats) {
          const isBuilding =
            (f.sourceLayer && /building/i.test(f.sourceLayer)) ||
            (f.layer && /building/i.test(f.layer.id)) ||
            (/building/i.test(String(f.properties?.class||f.properties?.type||f.properties?.kind)));
          if (!isBuilding || !f.geometry) continue;

          const geom = f.geometry;
          const rings = geom.type === 'Polygon'
            ? [geom.coordinates[0]]
            : geom.type === 'MultiPolygon'
              ? geom.coordinates.map(p=>p[0])
              : null;
          if (!rings) continue;

          // crude area proxy
          let size = 0;
          for (const ring of rings) size += ring.length;
          if (size > bestArea) { bestArea = size; best = f; }
        }
        if (best) return best.geometry;
      }
      return null;
    }

    map.on('load', async () => {
      // Hide labels
      for (const lyr of (map.getStyle().layers||[])) {
        if (lyr.type === 'symbol' || /label/i.test(lyr.id)) {
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }

      // Prepare empty collection
      const board = { type:'FeatureCollection', features: [] };

      // Keep view fixed so pixel windows are consistent
      map.jumpTo({zoom: 17.2, pitch: 60, bearing: -133.6});

      // For each target, query the visible building footprint and store it
      for (const t of TARGETS) {
        const pt = map.project(t.coord);
        const geom = getFootprintAt(pt);    // tries multiple paddings
        if (!geom) { console.warn('No footprint found for', t.name); continue; }
        board.features.push({
          type:'Feature',
          properties:{ type:'building', name:t.name, fill:t.color, height:22 },
          geometry: geom
        });
      }

      // Add source & layer for preview
      map.addSource('race', { type:'geojson', data: board });
      map.addLayer({
        id:'race-buildings',
        type:'fill-extrusion',
        source:'race',
        filter:['==', ['get','type'], 'building'],
        paint:{
          'fill-extrusion-color': ['get','fill'],
          'fill-extrusion-height': ['coalesce', ['get','height'], 22],
          'fill-extrusion-opacity': 0.96
        }
      });

      // Download button
      document.getElementById('downloadBtn').onclick = () => {
        downloadJSON(board, 'ysu_race_buildings_exact.geojson');
      };
    });
  </script>
</body>
</html>
