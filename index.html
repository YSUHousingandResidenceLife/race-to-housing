<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YSU Housing — Manual Capture 7/7 Buildings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html,body{height:100%;margin:0;font-family:sans-serif}
    #map{position:absolute; inset:0}
    .ui{position:absolute; right:12px; top:12px; z-index:20; background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px; width:320px}
    .ui header{font-weight:700; margin-bottom:6px}
    button{cursor:pointer; border:1px solid #444; border-radius:6px; padding:6px 10px; margin:2px 0}
    .checklist{display:grid; grid-template-columns:1fr auto; gap:4px; font-size:14px; margin-top:6px}
    .ok{color:#059669; font-weight:700}
    .missing{color:#b91c1c; font-weight:700}
    .metrics{font-size:12px; margin-top:6px}
    .hint{background:#f9fafb; border:1px dashed #ccc; font-size:12px; padding:6px; margin-top:6px}
  </style>
</head>
<body>
<div id="map"></div>

<div class="ui">
  <header>Manual Capture 7/7 Buildings</header>
  <button id="btnDownload">Download merged GeoJSON</button>
  <button id="btnReload">Reload existing file</button>

  <div class="metrics" id="metrics">Click a building footprint to capture.</div>

  <div class="checklist" id="cklist"></div>

  <div id="status" class="hint">
    Targets: Lyden, Cafaro, Christman, Weller, Wick, Kilcawley House, University Courtyards.<br/>
    Click each building outline on the map → it records ✔.
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
  center: [-80.6458, 41.1090],
  zoom: 16.8,
  pitch: 60,
  bearing: -133.6
});

const TARGETS = [
  {key:'lyden',name:'Lyden'},
  {key:'cafaro',name:'Cafaro'},
  {key:'christman',name:'Christman'},
  {key:'weller',name:'Weller'},
  {key:'wick',name:'Wick'},
  {key:'kilcawley house',name:'Kilcawley House'},
  {key:'university courtyards',name:'University Courtyards'}
];
const REQUIRED_KEYS = new Set(TARGETS.map(t=>t.key));
let buildingsFC = {type:'FeatureCollection',features:[]};
const captured={};

const ckbox=document.getElementById('cklist');
function renderChecklist(){
  ckbox.innerHTML='';
  for(const t of TARGETS){
    const rowL=document.createElement('div');
    const rowR=document.createElement('div');
    rowL.textContent=t.name;
    rowR.textContent=captured[t.key]?'✔':'—';
    rowR.className=captured[t.key]?'ok':'missing';
    ckbox.appendChild(rowL); ckbox.appendChild(rowR);
  }
}

function polygonMetrics(coords){
  const lats=coords.map(c=>c[1]), lngs=coords.map(c=>c[0]);
  const minLat=Math.min(...lats), maxLat=Math.max(...lats);
  const minLng=Math.min(...lngs), maxLng=Math.max(...lngs);
  const midLat=(minLat+maxLat)/2;
  const width=(maxLng-minLng)*111320*Math.cos(midLat*Math.PI/180);
  const length=(maxLat-minLat)*111320;
  return {width_m:Math.round(width), length_m:Math.round(length)};
}
function showMetrics(m){
  document.getElementById('metrics').textContent=`Width: ${m.width_m} m · Length: ${m.length_m} m`;
}

map.on('click',(e)=>{
  const fts=map.queryRenderedFeatures(e.point);
  const poly=fts.find(f=>f.geometry.type==='Polygon'||f.geometry.type==='MultiPolygon');
  if(!poly) return;

  // ask which building you just clicked
  const name=prompt("Which building is this? (Lyden, Cafaro, Christman, Weller, Wick, Kilcawley House, University Courtyards)");
  if(!name) return;
  const key=name.toLowerCase();
  if(!REQUIRED_KEYS.has(key)){alert("Not a recognized target name.");return;}

  const ring=poly.geometry.type==='Polygon'?poly.geometry.coordinates[0]:poly.geometry.coordinates[0][0];
  const m=polygonMetrics(ring); showMetrics(m);

  captured[key]={type:'Feature',geometry:poly.geometry,properties:{name, key, type:'building', width_m:m.width_m,length_m:m.length_m}};
  renderChecklist();
});

document.getElementById('btnDownload').onclick=()=>{
  const out={type:'FeatureCollection',features:[]};
  for(const f of buildingsFC.features||[]){
    const k=(f.properties?.key||'').toLowerCase();
    if(!REQUIRED_KEYS.has(k)) out.features.push(f);
  }
  for(const k in captured) out.features.push(captured[k]);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(out,null,2)],{type:'application/json'}));
  a.download='ysu_race_buildings_exact final.geojson';
  a.click();
};

async function loadExisting(){
  try{const r=await fetch('ysu_race_buildings_exact final.geojson',{cache:'no-store'});
      if(r.ok) buildingsFC=await r.json();
  }catch(e){}
}
document.getElementById('btnReload').onclick=loadExisting;

map.on('load',()=>{renderChecklist();loadExisting();});
</script>
</body>
</html>
