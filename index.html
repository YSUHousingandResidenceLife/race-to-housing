<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Race to Housing ‚Ä¢ YSU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ysu-red:#d50000; --ysu-black:#111; --gold:#ffca28;
    }
    html,body{margin:0;background:#0b0b0b;color:#fff;font-family:Inter,system-ui,Arial,sans-serif}
    header{
      padding:10px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:linear-gradient(90deg,#111, #1a1a1a);
      border-bottom:1px solid #222;
      position:sticky; top:0; z-index:5;
    }
    .brand{font-weight:800; letter-spacing:.4px}
    .panel{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{background:#191919; border:1px solid #2a2a2a; padding:6px 10px; border-radius:999px; font-size:14px}
    .btn{
      background:var(--ysu-red); border:none; color:#fff; font-weight:700; padding:8px 12px; border-radius:10px;
      cursor:pointer; transition:.2s transform ease;
    }
    .btn:active{transform:scale(.98)}
    #app{max-width:1400px; margin:0 auto; padding:12px}
    .map-wrap{
      position:relative; width:100%; aspect-ratio: 28/16; /* wide header-like banner */
      background:#000; overflow:hidden; border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35);
      border:1px solid #222;
    }
    .map{
      position:absolute; inset:0; background-size:cover; background-position:center;
      filter: saturate(1.05) contrast(1.06) brightness(1.03);
    }
    svg.overlay{position:absolute; inset:0}
    .route{fill:none; stroke:url(#grad); stroke-width:10; filter:url(#glow)}
    .route-dots circle{fill:var(--gold); opacity:.85}
    .penguin{
      position:absolute; width:48px; height:48px; transform:translate(-50%,-85%); pointer-events:none;
      transition: left .6s ease, top .6s ease;
      animation: waddle 0s linear 1; /* activated when moving */
      z-index:3;
    }
    .penguin.moving{ animation: waddle .6s ease; }
    @keyframes waddle{
      0%{ transform:translate(-50%,-85%) rotate(-6deg); }
      50%{ transform:translate(-50%,-85%) rotate(6deg); }
      100%{ transform:translate(-50%,-85%) rotate(0deg); }
    }
    .hud{
      position:absolute; left:14px; bottom:14px; z-index:4;
      background:rgba(15,15,15,.8); border:1px solid #2a2a2a; border-radius:12px; padding:10px 12px;
      backdrop-filter: blur(6px);
    }
    .hud h3{margin:0 0 6px 0; font-size:14px; opacity:.9}
    .hud .row{display:flex; gap:8px; align-items:center; margin-top:6px}
    input,select{
      background:#111; color:#fff; border:1px solid #2a2a2a; padding:8px 10px; border-radius:8px; outline:none
    }
    input::placeholder{color:#888}
    .notice{font-size:12px; opacity:.8; margin-top:6px}
    footer{opacity:.65; font-size:12px; text-align:center; padding:10px}
  </style>
</head>
<body>
<header>
  <div class="brand">üêß Race to Housing ‚Äî YSU</div>
  <div class="panel">
    <div class="chip"><b>Status:</b> <span id="status">Demo Mode</span></div>
    <div class="chip"><b>Player:</b> <span id="playerName">guest</span></div>
    <div class="chip"><b>Points:</b> <span id="pointsVal">0</span> / <span id="pointsMax">700</span></div>
    <button class="btn" id="btnLogin">Sign In</button>
  </div>
</header>

<main id="app">
  <div class="map-wrap" id="mapWrap">
    <div class="map" id="map"></div>
    <!-- SVG overlay draws route + dots -->
    <svg class="overlay" viewBox="0 0 1792 1024" preserveAspectRatio="none" id="overlay">
      <defs>
        <linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#d50000"/>
          <stop offset="100%" stop-color="#ff6d6d"/>
        </linearGradient>
        <filter id="glow">
          <feGaussianBlur stdDeviation="4" result="b"/>
          <feMerge>
            <feMergeNode in="b"/><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      <g id="routeGroup">
        <path id="routePath" class="route" d=""/>
        <g id="routeDots" class="route-dots"></g>
      </g>
    </svg>
    <!-- Penguin marker -->
    <img class="penguin" id="penguin" alt="penguin" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Emoji_u1f427.svg/64px-Emoji_u1f427.svg.png" />
    <!-- HUD -->
    <div class="hud">
      <h3>Redeem Code</h3>
      <div class="row">
        <input id="codeInput" placeholder="Enter code e.g. SOCIAL5" />
        <button class="btn" id="btnRedeem">Redeem</button>
      </div>
      <div class="notice">Test codes: <b>SOCIAL5</b>, <b>TASK10</b>, <b>EVENT25</b>, <b>BIG50</b>, <b>MOVE100</b></div>
    </div>
  </div>
</main>

<footer>Live board demo ‚Ä¢ Smooth interpolation along custom route ‚Ä¢ GitHub Pages friendly</footer>

<!-- Firebase (optional). If not configured, app runs in Demo Mode. -->
<script type="module">
/** =========================
 *  CONFIG
 *  ========================= */
const MAP_URL = "assets/ysu_game_map.png"; // <-- put your generated backdrop here
const FINISH_POINTS = 700;                 // finish line
const DOT_EVERY_PTS = 10;                  // for visual tiles
const STATUS = document.getElementById('status');
const PTS_EL = document.getElementById('pointsVal');
const PTS_MAX_EL = document.getElementById('pointsMax'); PTS_MAX_EL.textContent = FINISH_POINTS;
const PENGUIN = document.getElementById('penguin');
const MAP = document.getElementById('map');
MAP.style.backgroundImage = `url('${MAP_URL}')`;

/** Route definition:
 *  Use coordinates in the SVG viewBox space (1792x1024). These are sample waypoints.
 *  Adjust to trace your visual path (click-export tool later).
 */
const ROUTE_POINTS = [
  [140,850],[260,810],[380,770],[510,740],[660,700],
  [820,660],[980,640],[1120,600],[1240,540],[1350,480],
  [1460,430],[1550,380],[1620,330],[1660,280],[1700,230],
  [1730,190],[1750,150]
];

/** Built-in test codes (works in Demo Mode and in Firestore if documents match). */
const CODEBOOK = {
  "SOCIAL5":5, "TASK10":10, "EVENT25":25, "BIG50":50, "MOVE100":100
};

/** =========================
 *  GEOMETRY: path lengths & interpolation
 *  ========================= */
const segLens=[], cum=[], N=ROUTE_POINTS.length;
let total=0;
for(let i=0;i<N-1;i++){
  const [x1,y1]=ROUTE_POINTS[i], [x2,y2]=ROUTE_POINTS[i+1];
  const dx=x2-x1, dy=y2-y1, len=Math.hypot(dx,dy);
  segLens.push(len); total+=len; cum.push(total);
}
function distanceAtProgress(p){ return Math.max(0, Math.min(1,p)) * total; }
function pointAtDistance(d){
  if(d<=0) return {x:ROUTE_POINTS[0][0], y:ROUTE_POINTS[0][1]};
  if(d>=total) return {x:ROUTE_POINTS[N-1][0], y:ROUTE_POINTS[N-1][1]};
  let acc=0;
  for(let i=0;i<segLens.length;i++){
    const L=segLens[i];
    if(d<=acc+L){
      const t=(d-acc)/L;
      const [x1,y1]=ROUTE_POINTS[i], [x2,y2]=ROUTE_POINTS[i+1];
      return {x: x1 + t*(x2-x1), y: y1 + t*(y2-y1)};
    }
    acc+=L;
  }
  return {x:ROUTE_POINTS[N-1][0], y:ROUTE_POINTS[N-1][1]};
}
function xyFromPoints(points){ return points.map(p=>p.join(",")).join(" "); }

/** Draw path & dots (visual tiles every DOT_EVERY_PTS) */
const pathEl = document.getElementById('routePath');
pathEl.setAttribute("d","M "+ROUTE_POINTS.map(p=>p.join(" ")).join(" L "));
const dotsEl = document.getElementById('routeDots');
(function drawDots(){
  const totalDots = Math.floor(FINISH_POINTS / DOT_EVERY_PTS);
  for(let i=0;i<=totalDots;i++){
    const progress = i*DOT_EVERY_PTS / FINISH_POINTS;
    const d = distanceAtProgress(progress);
    const {x,y} = pointAtDistance(d);
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx", x); c.setAttribute("cy", y); c.setAttribute("r","7");
    dotsEl.appendChild(c);
  }
})();

/** =========================
 *  PLAYER STATE
 *  ========================= */
let appMode = "DEMO";          // "DEMO" or "FIREBASE"
let uid = "demo-player";
let displayName = "Guest Penguin";
let points = 0;

/** Move penguin to position derived from points */
function renderPenguin(){
  const progress = Math.max(0, Math.min(1, points/FINISH_POINTS));
  const d = distanceAtProgress(progress);
  const {x,y} = pointAtDistance(d);
  const wrap = document.getElementById('overlay');
  // overlay viewBox is 1792x1024, translate to pixel position within map-wrap
  const rect = wrap.getBoundingClientRect();
  const left = (x / 1792) * rect.width;
  const top  = (y / 1024) * rect.height;
  // trigger waddle animation by toggling class
  PENGUIN.classList.remove('moving'); void PENGUIN.offsetWidth; PENGUIN.classList.add('moving');
  PENGUIN.style.left = `${left}px`;
  PENGUIN.style.top  = `${top}px`;
  PTS_EL.textContent = Math.round(points);
}
window.addEventListener('resize', renderPenguin);

/** =========================
 *  DEMO MODE (LocalStorage)
 *  ========================= */
const LS_KEY="rth_demo_points_v1";
function loadDemo(){ points = +localStorage.getItem(LS_KEY) || 0; renderPenguin(); }
function saveDemo(){ localStorage.setItem(LS_KEY, String(points)); }
async function redeemDemo(code){
  const up = CODEBOOK[code.toUpperCase()];
  if(!up){ alert("Invalid code"); return; }
  points = Math.min(FINISH_POINTS, points + up);
  saveDemo(); renderPenguin();
}

/** =========================
 *  FIREBASE (optional)
 *  ========================= */
import { initializeApp }      from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:     "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId:  "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId:      "APP_ID",
};
let db, auth;

function tryInitFirebase(){
  try{
    // naive check: if keys are still placeholders, stay in demo
    if(firebaseConfig.projectId === "YOUR_PROJECT_ID") throw new Error("placeholder");
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    appMode = "FIREBASE";
    STATUS.textContent = "Connected";
  }catch(e){
    appMode = "DEMO";
    STATUS.textContent = "Demo Mode";
  }
}
tryInitFirebase();

async function ensurePlayerDoc(uid){
  const ref = doc(db,"players",uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      nickname: displayName || "Penguin",
      points: 0,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
  }
  return ref;
}
async function listenPlayer(uid){
  const ref = doc(db,"players",uid);
  onSnapshot(ref,(s)=>{
    if(s.exists()){
      const data = s.data();
      points = data.points || 0;
      displayName = data.nickname || "Penguin";
      document.getElementById('playerName').textContent = displayName;
      renderPenguin();
    }
  });
}
async function redeemFirebase(code){
  const upper = code.toUpperCase();
  const val = CODEBOOK[upper];
  if(!val){ alert("Invalid code"); return; }
  const pRef = doc(db,"players",uid);
  const cRef = doc(db,"codes", upper); // expect doc id = code string
  const claimsRef = doc(db, `players/${uid}/claims/${upper}`);

  await runTransaction(db, async (tx)=>{
    const [pSnap, cSnap, clSnap] = await Promise.all([
      tx.get(pRef), tx.get(cRef), tx.get(claimsRef)
    ]);
    if(!pSnap.exists()) throw new Error("Player missing");
    if(!cSnap.exists()) throw new Error("Code not found");
    if(clSnap.exists()) throw new Error("Code already used by this player");

    const curr = pSnap.data().points || 0;
    const add = cSnap.data().value || val; // fallback to CODEBOOK value
    const next = Math.min(FINISH_POINTS, curr + add);

    tx.update(pRef,{ points: next, updatedAt: serverTimestamp(), lastClaimAt: serverTimestamp() });
    tx.set(claimsRef,{ code: upper, value: add, claimedAt: serverTimestamp() });
  }).catch(e=>{ alert(e.message); });
}

/** =========================
 *  UI HOOKS
 *  ========================= */
document.getElementById('btnRedeem').addEventListener('click', async ()=>{
  const code = (document.getElementById('codeInput').value||"").trim();
  if(!code) return;
  if(appMode==="FIREBASE") await redeemFirebase(code);
  else await redeemDemo(code);
  document.getElementById('codeInput').value="";
});
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  if(appMode!=="FIREBASE"){ alert("Running in Demo Mode. Add your Firebase config to enable cloud sync."); return; }
  await signInAnonymously(auth);
});

if(appMode==="FIREBASE"){
  onAuthStateChanged(getAuth(), async (user)=>{
    if(user){
      uid = user.uid;
      displayName = user.isAnonymous ? "Penguin" : (user.displayName||"Penguin");
      document.getElementById('playerName').textContent = displayName;
      const ref = await ensurePlayerDoc(uid);
      await listenPlayer(uid);
    }else{
      STATUS.textContent="Signed out";
    }
  });
}else{
  // Demo boot
  loadDemo();
  document.getElementById('playerName').textContent = "Guest";
}

/** Initial render */
renderPenguin();
</script>
</body>
</html>
