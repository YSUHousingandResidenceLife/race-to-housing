<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YSU Housing — Map + Logo + Route Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <style>
    :root { --card:#fff; --border:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.12) }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{position:absolute; inset:0}
    .ui{
      position:absolute; right:12px; top:12px; z-index:20; width:min(460px,94vw);
      background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    }
    .ui header{padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700}
    .ui .body{padding:10px 12px; display:grid; gap:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{cursor:pointer; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:8px; font-weight:600}
    button.primary{background:#d6001c; color:#fff; border-color:#c21a1a}
    input[type="range"]{width:170px}
    .muted{color:#4b5563; font-size:13px}
    .hint{background:#f9fafb; border:1px dashed #e5e7eb; padding:8px 10px; border-radius:8px; font-size:13px}
  </style>
</head>
<body>
  <div id="map"></div>

  <section class="ui">
    <header>YSU Housing — Overlay, Camera & Route</header>
    <div class="body">
      <div class="row">
        <button id="btnShowLogo" class="primary">Show Logo</button>
        <button id="btnHideLogo">Hide Logo</button>
        <button id="btnPlaceLogo">Re-place (3 clicks)</button>
        <button id="btnFocusLogo">Focus Logo</button>
      </div>

      <div class="row">
        <button id="logoUnlock">Unlock Logo (drag)</button>
        <button id="logoLock">Lock Logo</button>
        <button id="logoSave">Save Logo Position</button>
        <button id="logoReset">Reset Logo</button>
      </div>

      <div class="row">
        <label class="muted">Logo Opacity</label>
        <input id="opacity" type="range" min="0" max="1" step="0.02" value="0.88" />
        <span id="opval" class="muted">0.88</span>
      </div>

      <div class="row">
        <button id="camSave" class="primary">Save Current View</button>
        <button id="camUseSaved">Use Saved View</button>
        <button id="camLock">Lock Camera</button>
        <button id="camUnlock">Unlock Camera</button>
      </div>

      <div class="row">
        <button id="routeStart" class="primary">Start / Resume Route</button>
        <button id="routeFinish">Finish & Download</button>
        <button id="routeClear">Clear Route</button>
      </div>

      <div id="status" class="hint">
        Needs: <code>ysu_race_buildings_exact final.geojson</code> and <code>housing-overlay.png</code> in this folder.  
        Tip: Right-drag (or compass) to rotate. Save the view when it looks perfect.
      </div>
    </div>
  </section>

  <!-- JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script>
    mapboxgl.accessToken =
      'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const STYLE_ID    = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
    const GEOJSON_URL = encodeURI('ysu_race_buildings_exact final.geojson'); // handles space in filename
    const IMAGE_URL   = './housing-overlay.png';

    const LS_LOGO   = 'housingLogoCoords';
    const LS_CAMERA = 'housingInitCamera';

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_ID,
      antialias: true,
      center: [-80.6458, 41.1090],
      zoom: 16.8,
      pitch: 60,
      bearing: -133.6,
      minZoom: 15,
      maxZoom: 19,
      maxBounds: [[-80.6570, 41.1026], [-80.6415, 41.1120]]
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.dragPan.enable(); map.scrollZoom.enable(); map.dragRotate.enable();
    map.touchZoomRotate.enable(); map.keyboard.enable();

    const statusEl = document.getElementById('status');
    const setStatus = t => statusEl.textContent = t;

    // Hide labels
    function hideLabels(){
      const layers = map.getStyle().layers || [];
      for (const lyr of layers){
        if (lyr.type==='symbol' || /label/i.test(lyr.id)){
          try { map.setLayoutProperty(lyr.id,'visibility','none'); } catch(e){}
        }
      }
    }
    map.on('styledata', hideLabels);

    // -------- Buildings (now fully covered: ground fill + extrusion) --------
    async function safeJSON(url){
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error(`Missing: ${url}`);
      return r.json();
    }
    function addBuildings(fc){
      if (map.getSource('housing-src')) map.removeSource('housing-src');
      map.addSource('housing-src', { type:'geojson', data: fc });

      // UNIQUE COLORS including University Courtyards
      const colorByName =
        ['case',
          ['==',['downcase',['get','name']],'lyden'],                 '#FFD23F', // yellow
          ['==',['downcase',['get','name']],'cafaro'],                '#FF9F1C', // orange
          ['==',['downcase',['get','name']],'christman'],             '#748B58', // olive
          ['==',['downcase',['get','name']],'weller'],                '#00E0E8', // aqua
          ['==',['downcase',['get','name']],'wick'],                  '#FF6B35', // arts house (warm)
          ['==',['downcase',['get','name']],'university courtyards'], '#9B59B6', // purple
          /* default */                                               '#D62D20'  // fallback red
        ];
      const colorExpr = ['coalesce',['get','fill'], colorByName];

      // 2D ground fill to color the entire footprint (so not just “tops”)
      if (map.getLayer('housing-fill')) map.removeLayer('housing-fill');
      map.addLayer({
        id:'housing-fill',
        type:'fill',
        source:'housing-src',
        paint:{
          'fill-color': colorExpr,
          'fill-opacity': 0.98
        }
      });

      // 3D extrusion (sides + roof) with uniform color (no vertical gradient)
      if (map.getLayer('housing-3d')) map.removeLayer('housing-3d');
      map.addLayer({
        id:'housing-3d',
        type:'fill-extrusion',
        source:'housing-src',
        paint:{
          'fill-extrusion-color': colorExpr,
          'fill-extrusion-height': ['coalesce',['get','height'],22],
          'fill-extrusion-base': 0,
          'fill-extrusion-vertical-gradient': false,
          'fill-extrusion-opacity': 1.0
        }
      }, 'housing-fill'); // keep above the 2D fill
    }

    // -------- Logo Overlay (draggable + savable) --------
    const IMAGE_SRC   = 'housing-logo-src';
    const IMAGE_LAYER = 'housing-logo-layer';
    const DEFAULT_CORNERS = [
      [-80.6469, 41.1116], // TL
      [-80.6441, 41.1116], // TR
      [-80.6441, 41.1076], // BR
      [-80.6469, 41.1076]  // BL
    ];

    const opSlider = document.getElementById('opacity');
    const opVal    = document.getElementById('opval');
    const updateOpacity = ()=>{
      opVal.textContent = parseFloat(opSlider.value).toFixed(2);
      if (map.getLayer(IMAGE_LAYER))
        map.setPaintProperty(IMAGE_LAYER,'raster-opacity', parseFloat(opSlider.value));
    };
    opSlider.addEventListener('input', updateOpacity);

    function ensureLogo(){
      if (!map.getSource(IMAGE_SRC)){
        map.addSource(IMAGE_SRC, { type:'image', url: IMAGE_URL, coordinates: DEFAULT_CORNERS });
        window.__logoCoords = DEFAULT_CORNERS.slice();
      }
      if (!map.getLayer(IMAGE_LAYER)){
        map.addLayer({
          id: IMAGE_LAYER, type:'raster', source: IMAGE_SRC,
          paint:{ 'raster-opacity': parseFloat(opSlider.value), 'raster-fade-duration': 0 }
        });
      }
    }
    function showLogo(){ ensureLogo(); map.setLayoutProperty(IMAGE_LAYER,'visibility','visible'); updateOpacity(); }
    function hideLogo(){ if(map.getLayer(IMAGE_LAYER)) map.setLayoutProperty(IMAGE_LAYER,'visibility','none'); }

    function getLogoCoords(){ return window.__logoCoords || null; }
    function setLogoCoords(coords){ window.__logoCoords = coords; map.getSource(IMAGE_SRC).setCoordinates(coords); }
    function saveLogoCoords(){ const c=getLogoCoords(); if(c) localStorage.setItem(LS_LOGO, JSON.stringify(c)); }
    function loadLogoCoordsIfAny(){
      const raw = localStorage.getItem(LS_LOGO);
      if (!raw) return false;
      try{ const c = JSON.parse(raw); if(Array.isArray(c)&&c.length===4){ setLogoCoords(c); return true; } }catch{}
      return false;
    }

    // Re-place via 3 clicks (TL, TR, BR)
    let placing=false, clicks=[];
    function startPlace(){
      showLogo(); placing=true; clicks=[];
      setStatus('Click TOP-LEFT, then TOP-RIGHT, then BOTTOM-RIGHT for the logo.');
      map.getCanvas().style.cursor='crosshair';
    }
    function finishPlace(){
      if (clicks.length<3) return;
      const [TL,TR,BR]=clicks;
      const BL=[ TL[0]+(BR[0]-TR[0]), TL[1]+(BR[1]-TR[1]) ];
      setLogoCoords([TL,TR,BR,BL]);
      placing=false; clicks=[];
      map.getCanvas().style.cursor='';
      setStatus('Logo placed. Drag/lock or save position.');
      flyToLogo(false);
    }
    map.on('click', e=>{
      if (!placing) return;
      clicks.push([e.lngLat.lng, e.lngLat.lat]);
      if (clicks.length===1) setStatus('TL saved. Click TOP-RIGHT.');
      if (clicks.length===2) setStatus('TR saved. Click BOTTOM-RIGHT.');
      if (clicks.length===3) finishPlace();
    });

    // Drag logo
    let dragEnabled=false, dragging=false, last=null;
    function enableDrag(){ showLogo(); dragEnabled=true; map.dragPan.disable(); map.getCanvas().style.cursor='grab'; setStatus('Drag to move the logo.'); }
    function disableDrag(){ dragEnabled=false; dragging=false; last=null; map.dragPan.enable(); map.getCanvas().style.cursor=''; setStatus('Logo locked.'); }
    map.on('mousedown', e=>{ if(!dragEnabled||!map.getSource(IMAGE_SRC)) return; dragging=true; last=e.lngLat; map.getCanvas().style.cursor='grabbing'; });
    map.on('mousemove', e=>{
      if (!dragEnabled || !dragging || !last) return;
      const dx=e.lngLat.lng-last.lng, dy=e.lngLat.lat-last.lat;
      setLogoCoords((getLogoCoords()||DEFAULT_CORNERS).map(([lng,lat])=>[lng+dx, lat+dy]));
      last=e.lngLat;
    });
    map.on('mouseup', ()=>{ if(!dragEnabled) return; dragging=false; map.getCanvas().style.cursor='grab'; });

    // Camera helpers
    function flyToLogo(initial = true) {
      const coords = getLogoCoords() || DEFAULT_CORNERS;
      const lons = coords.map(c => c[0]), lats = coords.map(c => c[1]);
      const sw = [Math.min(...lons), Math.min(...lats)];
      const ne = [Math.max(...lons), Math.max(...lats)];

      map.fitBounds([sw, ne], {
        padding: { top: 80, right: 80, bottom: 160, left: 120 },
        duration: initial ? 0 : 900,
        maxZoom: 18
      });
      map.easeTo({ pitch: 60, bearing: -133.6, duration: initial ? 0 : 900 });
      map.once('moveend', () => map.easeTo({ zoom: Math.min(map.getZoom()+0.4, 18), duration: initial ? 0 : 600 }));
    }
    function saveCurrentView(){
      const cam={center:map.getCenter(),zoom:map.getZoom(),pitch:map.getPitch(),bearing:map.getBearing()};
      localStorage.setItem(LS_CAMERA, JSON.stringify(cam));
      alert('Saved current view.');
    }
    function useSavedView(){
      const raw=localStorage.getItem(LS_CAMERA);
      if(!raw){alert('No saved view yet.'); return;}
      try{
        const c=JSON.parse(raw);
        map.jumpTo({center:[c.center.lng,c.center.lat],zoom:c.zoom,pitch:c.pitch,bearing:c.bearing});
      }catch{ alert('Saved view unreadable. Save again.'); }
    }
    function lockCamera(){
      map.dragPan.disable(); map.scrollZoom.disable(); map.dragRotate.disable(); map.touchZoomRotate.disable();
      map.keyboard.disable(); map.boxZoom.disable(); map.doubleClickZoom.disable();
      setStatus('Camera locked. Unlock to move again.');
    }
    function unlockCamera(){
      map.dragPan.enable(); map.scrollZoom.enable(); map.dragRotate.enable(); map.touchZoomRotate.enable();
      map.keyboard.enable(); map.boxZoom.enable(); map.doubleClickZoom.enable();
      setStatus('Camera unlocked.');
    }

    // -------- Route Editor (ground-level red dots) --------
    const Draw=new MapboxDraw({displayControlsDefault:false,controls:{line_string:true,trash:true}});
    map.addControl(Draw,'top-right');

    function densify(line, spacingMeters=3){
      const R=6371000,toRad=d=>d*Math.PI/180;
      const gcDist=(A,B)=>{const [lng1,lat1]=A,[lng2,lat2]=B;
        const dLat=toRad(lat2-lat1),dLng=toRad(lng2-lng1);
        const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
        return 2*R*Math.asin(Math.sqrt(a));};
      const lerp=(A,B,t)=>[A[0]+(B[0]-A[0])*t,A[1]+(B[1]-A[1])*t];
      const pts=[],coords=line.geometry.coordinates;
      for(let i=0;i<coords.length-1;i++){
        const A=coords[i],B=coords[i+1],seg=gcDist(A,B),n=Math.max(1,Math.floor(seg/spacingMeters));
        for(let k=0;k<=n;k++){ const t=k/n; pts.push({type:'Feature',geometry:{type:'Point',coordinates:lerp(A,B,t)}}); }
      }
      return {type:'FeatureCollection',features:pts};
    }
    function currentLines(){return Draw.getAll().features.filter(f=>f.geometry?.type==='LineString');}
    function updateRoutePreview(){
      const lines=currentLines(); const pts={type:'FeatureCollection',features:[]};
      for(const ln of lines) pts.features.push(...densify(ln,3).features);
      if(map.getSource('route-points-src')) map.getSource('route-points-src').setData(pts);
    }

    // UI Buttons
    document.getElementById('btnShowLogo').onclick  = showLogo;
    document.getElementById('btnHideLogo').onclick  = hideLogo;
    document.getElementById('btnPlaceLogo').onclick = startPlace;
    document.getElementById('btnFocusLogo').onclick = () => flyToLogo(false);

    document.getElementById('logoUnlock').onclick   = enableDrag;
    document.getElementById('logoLock').onclick     = disableDrag;
    document.getElementById('logoSave').onclick     = () => { saveLogoCoords(); alert('Logo position saved.'); };
    document.getElementById('logoReset').onclick    = () => {
      localStorage.removeItem(LS_LOGO);
      showLogo(); setLogoCoords(DEFAULT_CORNERS); flyToLogo(false);
      alert('Logo position reset.');
    };

    document.getElementById('camSave').onclick      = saveCurrentView;
    document.getElementById('camUseSaved').onclick  = useSavedView;
    document.getElementById('camLock').onclick      = lockCamera;
    document.getElementById('camUnlock').onclick    = unlockCamera;

    document.getElementById('routeStart').onclick   = () => {
      map.doubleClickZoom.disable();
      Draw.changeMode('draw_line_string');
      map.getCanvas().style.cursor='crosshair';
      setStatus('Drawing route: click to add points; double-click to finish.');
    };
    document.getElementById('routeFinish').onclick  = () => {
      map.doubleClickZoom.enable(); map.getCanvas().style.cursor='';
      const lines=currentLines();
      if(!lines.length){ alert('No route yet.'); return; }
      const out={type:'FeatureCollection',features:lines};
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([JSON.stringify(out,null,2)],{type:'application/json'}));
      a.download='route.geojson'; a.click();
      setStatus('Route downloaded as route.geojson.');
    };
    document.getElementById('routeClear').onclick   = () => { Draw.deleteAll(); updateRoutePreview(); setStatus('Route cleared.'); };

    // Load assets & init sources/layers
    map.on('load', async ()=>{
      // Buildings
      try{ addBuildings(await safeJSON(GEOJSON_URL)); setStatus('Buildings loaded with full coverage.'); }
      catch(e){ setStatus('Could not load buildings GeoJSON. Check file name/path.'); }

      // Route preview source/layer (below 3D buildings so it hugs ground)
      if (!map.getSource('route-points-src')){
        map.addSource('route-points-src',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
        map.addLayer({
          id:'route-dots', type:'circle', source:'route-points-src',
          layout:{ 'circle-pitch-alignment':'map' },
          paint:{
            'circle-color':'#D62D20',
            'circle-radius':['interpolate',['linear'],['zoom'],14,5.5,16,7.5,18,9.0],
            'circle-opacity':0.95,
            'circle-pitch-scale':'map'
          }
        }, 'housing-3d');
      }

      // Logo
      try{
        const r = await fetch(IMAGE_URL,{cache:'no-store'});
        if(!r.ok) throw 0;
        ensureLogo();
        if (!loadLogoCoordsIfAny()){ setLogoCoords(DEFAULT_CORNERS); saveLogoCoords(); }
        updateOpacity();
      }catch(e){
        setStatus('Logo not found. Add housing-overlay.png next to this file, then click “Show Logo”.');
      }

      // Use saved camera if any; else frame the logo
      const rawCam = localStorage.getItem(LS_CAMERA);
      if (rawCam){
        try{
          const c=JSON.parse(rawCam);
          map.jumpTo({center:[c.center.lng,c.center.lat],zoom:c.zoom,pitch:c.pitch,bearing:c.bearing});
        }catch{ flyToLogo(true); }
      } else {
        flyToLogo(true);
      }

      // keep route preview live
      map.on('draw.create', updateRoutePreview);
      map.on('draw.update', updateRoutePreview);
      map.on('draw.delete', updateRoutePreview);
    });
  </script>
</body>
</html>
