<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Race to Housing Board</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken =
      'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const STYLE_ID = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
    const DATA_URL = 'ysu_race_buildings_exact.geojson'; // <-- your saved file (same folder as index.html)

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_ID,
      center: [-80.644685, 41.107524],
      zoom: 17.2,
      pitch: 60,
      bearing: -133.6,
      minZoom: 15,
      maxZoom: 19,
      maxBounds: [
        [-80.6570, 41.1026], // SW
        [-80.6415, 41.1120]  // NE
      ]
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // Helper: fetch JSON safely and log issues
    async function loadJSON(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`Failed to load ${url} (${r.status})`);
      return r.json();
    }

    map.on('load', async () => {
      // 1) Hide ALL labels
      for (const lyr of (map.getStyle().layers || [])) {
        if (lyr.type === 'symbol' || /label/i.test(lyr.id)) {
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }
      // 2) Also hide base-style building extrusions so our colored ones are obvious
      for (const lyr of (map.getStyle().layers || [])) {
        if (/building/i.test(lyr.id) && (lyr.type === 'fill-extrusion' || lyr.type === 'fill')) {
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }

      // 3) Load your saved GeoJSON
      let data;
      try {
        data = await loadJSON(DATA_URL);
        console.log('Loaded GeoJSON:', DATA_URL, data);
      } catch (err) {
        console.error(err);
        alert('Could not load ysu_race_buildings_exact.geojson. Make sure it is in the same folder as index.html.');
        return;
      }

      // Quick sanity check + auto-fix: ensure features have a color
      if (data && data.features) {
        for (const f of data.features) {
          // If no color found, assign a default (YSU red) so it shows up
          if (!f.properties) f.properties = {};
          if (!('fill' in f.properties)) f.properties.fill = '#d6001c';
          // Tag as building if missing, so future filters work
          if (!('type' in f.properties)) f.properties.type = 'building';
        }
      }

      // 4) Add your data source and colored 3D layer
      map.addSource('race', { type: 'geojson', data, generateId: true });

      map.addLayer({
        id: 'race-buildings',
        type: 'fill-extrusion',
        source: 'race',
        // No filter → render all polygons from your file
        paint: {
          'fill-extrusion-color': ['coalesce', ['get', 'fill'], '#d6001c'],
          'fill-extrusion-height': ['coalesce', ['get', 'height'], 22],
          'fill-extrusion-opacity': 0.96
        }
      });

      // Surface any style errors
      map.on('error', e => { if (e && e.error) console.error('Mapbox error:', e.error); });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Race to Housing — Capture Building Footprints</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html,body{height:100%;margin:0}
    #map{position:absolute;inset:0}
    .ui{position:absolute;top:12px;left:12px;z-index:10;display:flex;gap:8px;align-items:center}
    .btn{background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px 12px;font:14px system-ui;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.1)}
    .pill{background:#000;color:#fff;border-radius:999px;padding:6px 10px;font:12px system-ui;opacity:.8}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="ui">
    <button id="downloadBtn" class="btn">Download buildings (.geojson)</button>
    <span id="status" class="pill">Capturing…</span>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';
    const STYLE = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
    const campusBounds = [[-80.6570, 41.1026], [-80.6415, 41.1120]];

    // Your buildings (name, color, [lng,lat])
    const TARGETS = [
      {name:'Lyden House',       color:'#FFD94A', coord:[-80.647458, 41.111143]},
      {name:'Cafaro House',      color:'#FF8A00', coord:[-80.6461376731338, 41.11100745921387]},
      {name:'Christman Dining',  color:'#808000', coord:[-80.64724052183561, 41.110525670257104]},
      {name:'Weller House',      color:'#00FFFF', coord:[-80.64483333333334, 41.10769444444445]}, // 41°06'27.7"N, 80°38'41.4"W
      {name:'Wick House (Art)',  color:'#B67BFF', coord:[-80.64426251711262, 41.107489184836176]},
      {name:'Kilcawley House',   color:'#00A651', coord:[-80.64731987291158, 41.10673909169142]},
    ];

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE,
      center: [-80.644685, 41.107524],
      zoom: 17.2,
      pitch: 60,
      bearing: -133.6,
      maxBounds: campusBounds,
      minZoom: 15,
      maxZoom: 19
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    const statusEl = document.getElementById('status');

    // Helpers
    function downloadJSON(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function getFootprintAt(pointPx, paddings=[12,16,22,28]) {
      for (const pad of paddings) {
        const bbox = [[pointPx.x - pad, pointPx.y - pad],[pointPx.x + pad, pointPx.y + pad]];
        const feats = map.queryRenderedFeatures(bbox);
        let best = null, bestArea = 0;
        for (const f of feats) {
          const isBuilding = (f.sourceLayer && /building/i.test(f.sourceLayer)) || (f.layer && /building/i.test(f.layer.id));
          if (!isBuilding || !f.geometry) continue;
          const g = f.geometry;
          const polys = g.type === 'Polygon' ? [g.coordinates] :
                        g.type === 'MultiPolygon' ? g.coordinates : null;
          if (!polys) continue;
          // crude "size" metric: total ring vertex count
          let size = 0;
          for (const poly of polys) for (const ring of poly) size += ring.length;
          if (size > bestArea) { bestArea = size; best = g; }
        }
        if (best) return best;
      }
      return null;
    }

    // Wait for style + tiles to settle, then capture
    map.once('idle', () => {
      const board = { type:'FeatureCollection', features: [] };
      let captured = 0;

      for (const t of TARGETS) {
        const pt = map.project(t.coord);
        const geom = getFootprintAt(pt);
        if (geom) {
          board.features.push({
            type:'Feature',
            properties:{ type:'building', name:t.name, fill:t.color, height:22 },
            geometry: geom
          });
          captured++;
        } else {
          console.warn('No footprint found for', t.name, 'at', t.coord);
        }
      }

      // Add to map so you can see colors immediately
      map.addSource('race', { type:'geojson', data: board });
      map.addLayer({
        id:'race-buildings',
        type:'fill-extrusion',
        source:'race',
        paint:{
          'fill-extrusion-color': ['get','fill'],
          'fill-extrusion-height': ['coalesce', ['get','height'], 22],
          'fill-extrusion-opacity': 0.96
        }
      });

      statusEl.textContent = `Captured ${captured}/${TARGETS.length}`;
      if (captured === 0) statusEl.textContent += ' — zoom in a bit and refresh.';
      // Hide all labels AFTER capture (so building layers were queryable)
      for (const lyr of (map.getStyle().layers||[])) {
        if (lyr.type === 'symbol' || /label/i.test(lyr.id)) {
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }

      // Download button
      document.getElementById('downloadBtn').onclick = () => {
        downloadJSON(board, 'ysu_race_buildings_exact.geojson');
      };
    });
  </script>
</body>
</html>
