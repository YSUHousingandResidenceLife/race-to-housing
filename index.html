<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Race to Housing â€” Path Viewer</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />

<style>
html, body { height:100%; margin:0; overflow:hidden; }
#map { position:absolute; inset:0; }

/* Left Console */
.console-left{
  position:absolute; bottom:20px; left:20px;
  width:220px; padding:15px;
  background:rgba(17,17,17,.9);
  color:#fff; border-radius:12px;
  border:2px solid #E4002B;
  z-index:10;
}
.console-left h2{
  font-size:14px; margin:0 0 10px;
  color:#E4002B; text-transform:uppercase;
}
.leader-item{
  display:flex; justify-content:space-between;
  font-size:13px; margin:6px 0;
}

/* Right Console */
.console-right{
  position:absolute; bottom:20px; right:20px;
  width:260px; padding:15px;
  background:rgba(255,255,255,.95);
  border-radius:12px; z-index:10;
}
.console-right input{
  width:100%; padding:8px; margin-bottom:8px;
}
.btn-redeem{
  width:100%; padding:10px;
  background:#E4002B; color:#fff;
  border:none; border-radius:6px;
}
.btn-help{
  width:100%; padding:8px;
  margin-top:6px;
}
#score-display{
  display:block; text-align:center;
  font-weight:bold; color:#E4002B;
  margin-bottom:8px;
}
</style>
</head>

<!-- Firebase (module) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, collection, query, where,
  orderBy, limit, runTransaction,
  serverTimestamp, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB6Yg6UMpfIjlKAqyV50egsXnlnWY1RyBM",
  authDomain: "race-to-housing.firebaseapp.com",
  projectId: "race-to-housing",
  storageBucket: "race-to-housing.firebasestorage.app",
  messagingSenderId: "569695954799",
  appId: "1:569695954799:web:93f20901d27bebaeadaa9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
window.doc = doc;
window.collection = collection;
window.query = query;
window.where = where;
window.orderBy = orderBy;
window.limit = limit;
window.runTransaction = runTransaction;
window.serverTimestamp = serverTimestamp;
window.onSnapshot = onSnapshot;
</script>

<body>
<div id="map"></div>

<div class="console-left">
  <h2>Top 7 Players</h2>
  <div id="leaderboard-list"></div>
</div>

<div class="console-right">
  <span id="score-display">Progress: 0 / 1000</span>
  <input id="username" placeholder="Username" />
  <input id="redeemCode" placeholder="Redemption Code" />
  <button class="btn-redeem" onclick="validateCode()">Redeem Code</button>
  <button class="btn-help" onclick="location.href='instructions.html'">Instructions</button>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

const GEOJSON_URL = 'ysu_race_buildings_exact_final.geojson';
const COURTYARDS_URL = 'university_courtyards.geojson';
const BRICKS_FILE_URL = 'race_bricks.geojson';

let allBricks = [];
const totalPoints = 1000;

const map = new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
  center:[-80.64848,41.10985],
  zoom:16.7, pitch:60, bearing:-172
});

async function loadJSON(url){
  const r = await fetch(url);
  return r.json();
}

function liveLeaderboard(){
  const q = window.query(
    window.collection(window.db,"players"),
    window.where("points",">",0),
    window.orderBy("points","desc"),
    window.limit(7)
  );
  window.onSnapshot(q,snap=>{
    const list=document.getElementById("leaderboard-list");
    list.innerHTML="";
    let i=1;
    snap.forEach(d=>{
      list.innerHTML+=`
        <div class="leader-item">
          <span>${i}. ${d.id}</span>
          <span>${d.data().points||0}</span>
        </div>`;
      i++;
    });
  });
}

function updatePlayerOnMap(username, coords){
  const src = map.getSource('players');
  if(!src) return;
  const data = src._data || {type:'FeatureCollection',features:[]};
  const i = data.features.findIndex(f=>f.properties.username===username);
  const f = {type:'Feature',geometry:{type:'Point',coordinates:coords},properties:{username}};
  if(i>=0) data.features[i]=f; else data.features.push(f);
  src.setData(data);
}

map.on('load', async ()=>{

  liveLeaderboard();

  const race = await loadJSON(GEOJSON_URL).catch(()=>null);
  const courtyards = await loadJSON(COURTYARDS_URL).catch(()=>null);
  const brickData = await loadJSON(BRICKS_FILE_URL).catch(()=>null);

  if(brickData){
    allBricks = brickData.features;
    map.addSource('players',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    map.addLayer({
      id:'players-layer',
      type:'symbol',
      source:'players',
      layout:{
        'text-field':'ðŸ§',
        'text-size':['interpolate',['linear'],['zoom'],14,18,16,26,18,34],
        'text-offset':[0,-0.4],
        'text-allow-overlap':true
      }
    });
  }
});

window.validateCode = async ()=>{
  const username = usernameInput.value.trim();
  const code = redeemCode.value.trim();
  if(!username||!code) return alert("Enter username & code");

  const playerRef = window.doc(window.db,"players",username);
  const codeRef = window.doc(window.db,"codes",code);
  const claimRef = window.doc(window.db,"globalClaims",code);

  await window.runTransaction(window.db, async tx=>{
    const c = await tx.get(codeRef);
    if(!c.exists()) throw "Invalid code";
    if((await tx.get(claimRef)).exists()) throw "Already claimed";

    const p = await tx.get(playerRef);
    if(!p.exists()) throw "User not found";

    const pts = (p.data().points||0)+c.data().points;
    const idx = Math.min(allBricks.length-1, Math.floor(pts/(totalPoints/allBricks.length)));

    tx.update(playerRef,{points:pts,brickIndex:idx,lastUpdated:window.serverTimestamp()});
    tx.set(claimRef,{claimedBy:username,claimedAt:window.serverTimestamp()});

    updatePlayerOnMap(username, allBricks[idx].geometry.coordinates);
    score-display.innerText = `Progress: ${pts} / 1000`;
  });
};
</script>
</body>
</html>
