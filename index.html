<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YSU Housing — Capture Courtyards (merge into GeoJSON with color)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet" />
  <style>
    :root { --card:#fff; --border:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.12) }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{position:absolute; inset:0}
    .ui{
      position:absolute; right:12px; top:12px; z-index:20; width:min(460px,94vw);
      background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    }
    .ui header{padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700}
    .ui .body{padding:10px 12px; display:grid; gap:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{cursor:pointer; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:8px; font-weight:600}
    button.primary{background:#d6001c; color:#fff; border-color:#c21a1a}
    input[type="text"]{padding:8px 10px; border:1px solid var(--border); border-radius:8px; width:220px}
    .muted{color:#4b5563; font-size:13px}
    .hint{background:#f9fafb; border:1px dashed #e5e7eb; padding:8px 10px; border-radius:8px; font-size:13px}
  </style>
</head>
<body>
  <div id="map"></div>

  <section class="ui">
    <header>Capture University Courtyards → merge into buildings file</header>
    <div class="body">
      <div class="row">
        <button id="btnStart" class="primary">Draw Courtyards Footprint</button>
        <button id="btnFinish">Finish Drawing</button>
        <button id="btnClear">Clear Draft</button>
      </div>

      <div class="row">
        <label class="muted">Name</label>
        <input id="nameInput" type="text" value="University Courtyards" />
        <label class="muted">Color</label>
        <input id="colorInput" type="text" value="#9B59B6" />
        <label class="muted">Height (m)</label>
        <input id="heightInput" type="text" value="22" style="width:90px" />
      </div>

      <div class="row">
        <button id="btnSaveMerged" class="primary">Save Updated GeoJSON</button>
        <button id="btnReload">Reload Source</button>
      </div>

      <div id="status" class="hint">
        Make sure <code>ysu_race_buildings_exact final.geojson</code> is in this folder. Draw the Courtyards polygon (click around its footprint, double-click to close), then “Save Updated GeoJSON” to download a merged file. Replace the repo file with it.
      </div>
    </div>
  </section>

  <!-- JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script>
    mapboxgl.accessToken =
      'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const STYLE_ID    = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
    const GEOJSON_URL = encodeURI('ysu_race_buildings_exact final.geojson'); // handles space in filename

    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_ID,
      antialias: true,
      center: [-80.6458, 41.1090],
      zoom: 16.8,
      pitch: 60,
      bearing: -133.6,
      minZoom: 15,
      maxZoom: 19,
      maxBounds: [[-80.6570, 41.1026], [-80.6415, 41.1120]]
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    const statusEl = document.getElementById('status');
    const setStatus = t => statusEl.textContent = t;

    // Hide labels for clarity
    function hideLabels(){
      const layers = map.getStyle().layers || [];
      for (const lyr of layers){
        if (lyr.type==='symbol' || /label/i.test(lyr.id)){
          try { map.setLayoutProperty(lyr.id,'visibility','none'); } catch(e){}
        }
      }
    }
    map.on('styledata', hideLabels);

    // ---------- Load current buildings ----------
    let buildingsFC = { type:'FeatureCollection', features:[] };

    async function loadBuildings(){
      try{
        const r = await fetch(GEOJSON_URL, {cache:'no-store'});
        if(!r.ok) throw 0;
        buildingsFC = await r.json();
        setStatus('Loaded existing buildings file. You can draw Courtyards now.');
      } catch(e){
        buildingsFC = { type:'FeatureCollection', features:[] };
        setStatus('Could not load buildings file. You can still draw Courtyards and save a new file.');
      }
      renderBuildings();
    }

    function renderBuildings(){
      if (map.getSource('housing-src')) {
        map.getSource('housing-src').setData(buildingsFC);
      } else {
        map.addSource('housing-src', { type:'geojson', data: buildingsFC });
      }

      // name lowercase helper
      const lname = ['downcase', ['to-string', ['get','name']]];
      const colorByName =
        ['case',
          ['in', lname, ['literal',['lyden']]],                 '#FFD23F',
          ['in', lname, ['literal',['cafaro']]],                '#FF9F1C',
          ['in', lname, ['literal',['christman']]],             '#748B58',
          ['in', lname, ['literal',['weller']]],                '#00E0E8',
          ['in', lname, ['literal',['wick','wick house','wick house (arts)']]], '#FF6B35',
          ['in', lname, ['literal',['university courtyards','university courtyard','courtyards','university courtyards 91 wick oval st']]], '#9B59B6',
          /* default */                                          '#D62D20'
        ];
      const colorExpr = ['coalesce',['get','fill'], colorByName];

      // 2D ground fill (makes whole footprint colored) — but only for polygons
      if (map.getLayer('housing-fill')) map.removeLayer('housing-fill');
      map.addLayer({
        id:'housing-fill', type:'fill', source:'housing-src',
        filter:['==', ['geometry-type'], 'Polygon'],
        paint:{ 'fill-color': colorExpr, 'fill-opacity': 0.98 }
      });

      // 3D extrusion (roof+sides) for polygons
      if (map.getLayer('housing-3d')) map.removeLayer('housing-3d');
      map.addLayer({
        id:'housing-3d', type:'fill-extrusion', source:'housing-src',
        filter:['==', ['geometry-type'], 'Polygon'],
        paint:{
          'fill-extrusion-color': colorExpr,
          'fill-extrusion-height': ['coalesce',['get','height'],22],
          'fill-extrusion-base': 0,
          'fill-extrusion-vertical-gradient': false,
          'fill-extrusion-opacity': 1.0
        }
      });
    }

    // ---------- Draw tools (Polygon capture) ----------
    const Draw = new MapboxDraw({
      displayControlsDefault:false,
      controls:{ polygon:true, trash:true },
      defaultMode:'simple_select',
      styles:[
        { id:'draw-fill', type:'fill',
          filter:['all',['==','$type','Polygon'],['!=','mode','static']],
          paint:{'fill-color':'#9B59B6','fill-opacity':0.25} },
        { id:'draw-line', type:'line',
          filter:['all',['==','$type','Polygon'],['!=','mode','static']],
          paint:{'line-color':'#9B59B6','line-width':2} },
        { id:'draw-vertex-halo', type:'circle',
          filter:['all',['==','meta','vertex'],['==','$type','Point'],['==','active','true']],
          paint:{'circle-radius':6,'circle-color':'#fff'} },
        { id:'draw-vertex', type:'circle',
          filter:['all',['==','meta','vertex'],['==','$type','Point'],['==','active','true']],
          paint:{'circle-radius':4,'circle-color':'#9B59B6'} }
      ]
    });
    map.addControl(Draw,'top-right');

    function startPolygon(){
      map.doubleClickZoom.disable();
      Draw.deleteAll();
      Draw.changeMode('draw_polygon');
      setStatus('Drawing: click around Courtyards footprint; double-click to close.');
    }
    function finishPolygon(){
      map.doubleClickZoom.enable();
      Draw.changeMode('simple_select');
      const fc = Draw.getAll();
      const poly = fc.features.find(f => f.geometry?.type==='Polygon');
      if (!poly){ alert('No polygon drawn yet.'); return; }

      // Properties
      const name   = document.getElementById('nameInput').value.trim() || 'University Courtyards';
      const fill   = document.getElementById('colorInput').value.trim() || '#9B59B6';
      const height = parseFloat(document.getElementById('heightInput').value) || 22;

      poly.properties = Object.assign({}, poly.properties, {
        name, fill, height
      });

      // Merge into buildingsFC (remove older Courtyards if present by name)
      buildingsFC.features = buildingsFC.features.filter(f => {
        const n = (f.properties?.name || '').toString().toLowerCase();
        return !['university courtyards','university courtyard','courtyards','university courtyards 91 wick oval st'].includes(n);
      });
      buildingsFC.features.push(poly);

      renderBuildings();
      setStatus(`Captured "${name}" and merged into the dataset. Click “Save Updated GeoJSON” to download.`);
    }
    function clearDraft(){
      Draw.deleteAll();
      setStatus('Draft cleared. You can draw again.');
    }

    // ---------- Save merged file ----------
    function saveMerged(){
      const a=document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(buildingsFC,null,2)],{type:'application/json'}));
      a.download = 'ysu_race_buildings_exact final.geojson';
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus('Downloaded merged file. Replace the file in GitHub with this one, then refresh.');
    }

    // ---------- UI wiring ----------
    document.getElementById('btnStart').onclick  = startPolygon;
    document.getElementById('btnFinish').onclick = finishPolygon;
    document.getElementById('btnClear').onclick  = clearDraft;
    document.getElementById('btnSaveMerged').onclick = saveMerged;
    document.getElementById('btnReload').onclick = () => { loadBuildings(); };

    // ---------- Boot ----------
    map.on('load', async ()=>{
      hideLabels();
      await loadBuildings();
      setStatus('Ready: click “Draw Courtyards Footprint”, trace the building, then “Finish Drawing” and “Save Updated GeoJSON”.');
    });
  </script>
</body>
</html>
