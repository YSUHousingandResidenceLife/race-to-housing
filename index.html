<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Housing Map — Colors + Logo Overlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { --card:#fff; --border:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.12) }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{position:absolute; inset:0}

    .ui{
      position:absolute; right:12px; top:12px; z-index:20; width:min(380px,92vw);
      background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    }
    .ui header{padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700}
    .ui .body{padding:10px 12px; display:grid; gap:10px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{cursor:pointer; border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:8px; font-weight:600}
    button.primary{background:#d6001c; color:#fff; border-color:#c21a1a}
    input[type="range"]{width:160px}
    .muted{color:#4b5563; font-size:13px}
    .hint{background:#f9fafb; border:1px dashed #e5e7eb; padding:8px 10px; border-radius:8px; font-size:13px}
  </style>
</head>
<body>
  <div id="map"></div>

  <section class="ui">
    <header>Housing Overlay & Layers</header>
    <div class="body">
      <div class="row">
        <button id="btnShowLogo" class="primary">Show Logo</button>
        <button id="btnHideLogo">Hide Logo</button>
        <button id="btnPlaceLogo">Re-place Logo</button>
        <label class="muted">Opacity</label>
        <input id="opacity" type="range" min="0" max="1" step="0.02" value="0.85">
        <span id="opval" class="muted">0.85</span>
      </div>
      <div id="status" class="hint">
        Looking for <code>ysu_race_buildings_exact final.geojson</code> and <code>housing-overlay.png</code> in this folder…
      </div>
    </div>
  </section>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script>
    // ---------- Map base ----------
    mapboxgl.accessToken =
      'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
      center: [-80.6458, 41.1090],
      zoom: 16.8,
      pitch: 60,
      bearing: -133.6,
      minZoom: 15,
      maxZoom: 19,
      maxBounds: [[-80.6570, 41.1026], [-80.6415, 41.1120]]
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    const statusEl = document.getElementById('status');
    const opSlider = document.getElementById('opacity');
    const opVal = document.getElementById('opval');
    const setStatus = (t)=>statusEl.textContent=t;

    // ---------- Helpers ----------
    async function safeJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) throw new Error(`Not found: ${url}`);
      return r.json();
    }
    function hideLabels(){
      const layers = map.getStyle().layers || [];
      for (const lyr of layers){
        if (lyr.type==='symbol' || /label/i.test(lyr.id)){
          try { map.setLayoutProperty(lyr.id, 'visibility', 'none'); } catch(e){}
        }
      }
    }
    map.on('styledata', hideLabels);

    // ---------- Buildings (with colors) ----------
    const GEOJSON_PATH = encodeURI('ysu_race_buildings_exact final.geojson'); // filename with space handled

    function addBuildingsLayer(fc){
      if (map.getSource('housing-src')) map.removeSource('housing-src');
      map.addSource('housing-src', { type:'geojson', data: fc });

      // If a feature misses 'fill', fall back by name (tweak as you like)
      const colorByName =
        ['case',
          ['==', ['downcase', ['get','name']], 'lyden'], '#FFD23F',
          ['==', ['downcase', ['get','name']], 'cafaro'], '#FF9F1C',
          ['==', ['downcase', ['get','name']], 'christman'], '#748B58',
          ['==', ['downcase', ['get','name']], 'weller'], '#00E0E8',
          ['==', ['downcase', ['get','name']], 'wick'], '#FF6B35',
          /* default */ '#D62D20'
        ];

      const colorExpr = ['coalesce', ['get','fill'], colorByName];

      if (map.getLayer('housing-3d')) map.removeLayer('housing-3d');
      map.addLayer({
        id: 'housing-3d',
        type: 'fill-extrusion',
        source: 'housing-src',
        paint: {
          'fill-extrusion-color': colorExpr,
          'fill-extrusion-height': ['coalesce', ['get','height'], 22],
          'fill-extrusion-opacity': 0.96
        }
      });
    }

    // ---------- Logo overlay (image source) ----------
    const IMAGE_URL = './housing-overlay.png'; // must exist next to this file
    const IMAGE_SRC = 'housing-logo-src';
    const IMAGE_LAYER = 'housing-logo-layer';

    // Default placement over the housing cluster. Adjust if needed.
    const DEFAULT_CORNERS = [
      [-80.6469, 41.1116], // TL
      [-80.6440, 41.1116], // TR
      [-80.6440, 41.1076], // BR
      [-80.6469, 41.1076]  // BL
    ];

    function ensureLogoSource(){
      if (map.getSource(IMAGE_SRC)) return;
      map.addSource(IMAGE_SRC, { type:'image', url: IMAGE_URL, coordinates: DEFAULT_CORNERS });
    }
    function ensureLogoLayer(){
      if (map.getLayer(IMAGE_LAYER)) return;
      map.addLayer({
        id: IMAGE_LAYER,
        type: 'raster',
        source: IMAGE_SRC,
        paint: { 'raster-opacity': parseFloat(opSlider.value), 'raster-fade-duration': 0 }
      });
    }
    function showLogo(){
      ensureLogoSource(); ensureLogoLayer();
      map.setLayoutProperty(IMAGE_LAYER, 'visibility', 'visible');
      map.setPaintProperty(IMAGE_LAYER, 'raster-opacity', parseFloat(opSlider.value));
    }
    function hideLogo(){
      if (map.getLayer(IMAGE_LAYER)) map.setLayoutProperty(IMAGE_LAYER, 'visibility', 'none');
    }
    function updateOpacity(){
      opVal.textContent = parseFloat(opSlider.value).toFixed(2);
      if (map.getLayer(IMAGE_LAYER)){
        map.setPaintProperty(IMAGE_LAYER, 'raster-opacity', parseFloat(opSlider.value));
      }
    }
    opSlider.addEventListener('input', updateOpacity);

    // Re-place by clicking TL, TR, BR
    let placing = false, clicks = [];
    function startPlace(){
      placing = true; clicks = [];
      showLogo();
      setStatus('Click TOP-LEFT, then TOP-RIGHT, then BOTTOM-RIGHT for the logo.');
      map.getCanvas().style.cursor='crosshair';
    }
    function finishPlace(){
      if (clicks.length < 3) return;
      const [TL, TR, BR] = clicks;
      const BL = [ TL[0] + (BR[0]-TR[0]), TL[1] + (BR[1]-TR[1]) ];
      map.getSource(IMAGE_SRC).setCoordinates([TL, TR, BR, BL]);
      placing = false; clicks = [];
      map.getCanvas().style.cursor='';
      setStatus('Logo placed. Adjust opacity or re-place if needed.');
    }
    map.on('click', (e)=>{
      if (!placing) return;
      clicks.push([e.lngLat.lng, e.lngLat.lat]);
      if (clicks.length === 1) setStatus('TL saved. Click TOP-RIGHT.');
      if (clicks.length === 2) setStatus('TR saved. Click BOTTOM-RIGHT.');
      if (clicks.length === 3) finishPlace();
    });

    // ---------- UI wiring ----------
    document.getElementById('btnShowLogo').onclick  = showLogo;
    document.getElementById('btnHideLogo').onclick  = hideLogo;
    document.getElementById('btnPlaceLogo').onclick = startPlace;

    // ---------- Boot ----------
    map.on('load', async () => {
      hideLabels();

      // Try to load buildings
      try {
        const fc = await safeJSON(GEOJSON_PATH);
        addBuildingsLayer(fc);
        setStatus('Buildings loaded with colors. If some are grey, add a "fill" property in the GeoJSON or edit the fallback list.');
      } catch (e) {
        setStatus('Could not load buildings GeoJSON. Make sure the file is named exactly: “ysu_race_buildings_exact final.geojson” and is in this folder.');
      }

      // Try the logo image (show by default if it exists)
      try {
        const r = await fetch(IMAGE_URL, {cache:'no-store'});
        if (!r.ok) throw 0;
        showLogo(); // image found → display
      } catch (e) {
        setStatus('Logo not found. Put “housing-overlay.png” next to this HTML. Then click “Show Logo”.');
      }

      updateOpacity();
    });
  </script>
</body>
</html>
