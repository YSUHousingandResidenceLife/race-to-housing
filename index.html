<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Race to Housing — Exact Building Shapes</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #controls { position: absolute; top: 10px; left: 10px; z-index: 1; background: white; padding: 8px; border-radius: 6px; box-shadow: 0 0 6px rgba(0,0,0,0.3); }
    #status { font-size: 14px; margin-top: 6px; }
    button { margin-right: 8px; }
  </style>
</head>
<body>
<div id="controls">
  <button id="startCapture">Start Auto-Capture</button>
  <button id="downloadGeoJSON" disabled>Download_ysu_race_buildings_exact.geojson</button>
  <div id="status">YSU — Auto-Capture <span id="count">0</span>/7 captured</div>
</div>
<div id="map"></div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZxajR1cjYwMnd3Mm5xczZyYjh0bnNwIn0.AfUTz-VNc05MDbayKNduAw';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
  center: [-80.644685, 41.107524],
  zoom: 17.2,
  pitch: 60,
  bearing: -133.6,
  maxBounds: [
    [-80.654, 41.102],
    [-80.636, 41.112]
  ]
});

const buildings = [
  { name: 'University Courtyards', center: [-80.64268880113872, 41.10532694438848] },
  { name: 'Lyden House', center: [-80.65, 41.11] },
  { name: 'Cafaro House', center: [-80.65, 41.11] },
  { name: 'Christman Dining Commons', center: [-80.6468, 41.1068] },
  { name: 'Weller House', center: [-80.64, 41.11] },
  { name: 'Wick House', center: [-80.64, 41.11] },
  { name: 'Kilcawley Center', center: [-80.65, 41.11] }
];

const captured = [];
const updateStatus = () => {
  document.getElementById('count').textContent = captured.length;
  if (captured.length === buildings.length) {
    document.getElementById('downloadGeoJSON').disabled = false;
  }
};

const queryBuildingAt = async (map, center) => {
  return new Promise((resolve) => {
    let found = null;
    const tryRadii = [28, 42, 60, 85, 120, 160];
    for (let r = 0; r < tryRadii.length; r++) {
      const radius = tryRadii[r];
      const bounds = [
        map.unproject([map.project(center).x - radius, map.project(center).y - radius]),
        map.unproject([map.project(center).x + radius, map.project(center).y + radius])
      ];
      const features = map.queryRenderedFeatures(bounds, {
        layers: map.getStyle().layers.map(l => l.id)
      }).filter(f => f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon');
      if (features.length) {
        found = features[0];
        break;
      }
    }
    resolve(found);
  });
};

const captureBuildings = async () => {
  captured.length = 0;
  updateStatus();
  for (const b of buildings) {
    map.jumpTo({ center: b.center });
    await new Promise(r => setTimeout(r, 1000));
    const feature = await queryBuildingAt(map, b.center);
    if (feature) {
      feature.properties.name = b.name;
      captured.push(feature);
      updateStatus();
    }
  }
};

document.getElementById('startCapture').onclick = () => captureBuildings();
document.getElementById('downloadGeoJSON').onclick = () => {
  const geojson = {
    type: 'FeatureCollection',
    features: captured
  };
  const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ysu_race_buildings_exact.geojson';
  a.click();
};
</script>
</body>
</html>
