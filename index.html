<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Race to Housing â€” Path Viewer</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script>
    const GEOJSON_URL = 'ysu_race_buildings_exact_final.geojson';
    const BRICKS_FILE_URL = 'race_bricks.geojson';
    mapboxgl.accessToken = 'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
      center: [-80.6458, 41.1090],
      zoom: 16.8,
      pitch: 60,
      bearing: -133.6
    });

    async function loadJSON(url){ const r = await fetch(url); return r.json(); }

    function processBricks(data) {
      const sizeLng = 0.00005, sizeLat = 0.00009;
      return {
        type: 'FeatureCollection',
        features: data.features.map(f => {
          const [lng, lat] = f.geometry.coordinates;
          const angle = ((f.properties.rotation || 123) * -1) * (Math.PI / 180);
          const points = [[-sizeLng, -sizeLat], [sizeLng, -sizeLat], [sizeLng, sizeLat], [-sizeLng, sizeLat]];
          const rotated = points.map(([dx, dy]) => [
            lng + (dx * Math.cos(angle) - dy * Math.sin(angle)),
            lat + (dx * Math.sin(angle) + dy * Math.cos(angle))
          ]);
          rotated.push(rotated[0]);
          return { type: 'Feature', properties: f.properties, geometry: { type: 'Polygon', coordinates: [rotated] } };
        })
      };
    }

    map.on('load', async () => {
      const race = await loadJSON(GEOJSON_URL).catch(()=>null);
      const brickData = await loadJSON(BRICKS_FILE_URL).catch(()=>null);

      // 1. Housing Overlay
      map.addSource('housing-overlay', {
        type: 'image',
        url: 'housing-overlay.png',
        coordinates: [
          [-80.64760006745172, 41.10229501193964],
          [-80.65320155001069, 41.10444521963691],
          [-80.65140971026295, 41.10911312176939],
          [-80.64580822770398, 41.10696291407212]
        ]
      });
      map.addLayer({ id: 'housing-overlay-layer', type: 'raster', source: 'housing-overlay' });

      // 2. Buildings
      if(race) {
        map.addSource('race', { type:'geojson', data: race });
        map.addLayer({
          id:'race-buildings', type:'fill-extrusion', source:'race',
          paint:{
            'fill-extrusion-color': ['match', ['get','name'], 'Lyden House', '#FF69B4', 'Cafaro House', '#0072CE', 'Wick House (Art)', '#FFFF00', 'Weller House', '#582C83', 'Christman Dining', '#FFDF00', 'Kilcawley House', '#E4002B', '#d6001c'],
            'fill-extrusion-height': 22, 'fill-extrusion-opacity': 0.96
          }
        });
      }

      // 3. Bricks and Dynamic Signs
      if(brickData && brickData.features.length > 0) {
        map.addSource('dots', { type: 'geojson', data: processBricks(brickData) });
        map.addLayer({ id: 'dots-layer', type: 'fill', source: 'dots', paint: { 'fill-color': ['get', 'color'] } });

        // Identify Start (first index) and End (last index) from JSON
        const startPoint = brickData.features[0].geometry.coordinates;
        const endPoint = brickData.features[brickData.features.length - 1].geometry.coordinates;

        map.addSource('endpoints', {
          type: 'geojson',
          data: {
            type: 'FeatureCollection',
            features: [
              { type: 'Feature', geometry: { type: 'Point', coordinates: startPoint }, properties: { label: 'START', color: '#E4002B' } },
              { type: 'Feature', geometry: { type: 'Point', coordinates: endPoint }, properties: { label: 'FINISH', color: '#111111' } }
            ]
          }
        });

        // Floating Labels
        map.addLayer({
          id: 'endpoint-labels',
          type: 'symbol',
          source: 'endpoints',
          layout: {
            'text-field': ['get', 'label'],
            'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
            'text-size': 14,
            'text-letter-spacing': 0.1,
            'text-offset': [0, -2], // Floats it above the point
            'text-anchor': 'bottom'
          },
          paint: {
            'text-color': '#ffffff',
            'text-halo-color': ['get', 'color'],
            'text-halo-width': 3
          }
        });
      }
    });
  </script>
</body>
</html>
