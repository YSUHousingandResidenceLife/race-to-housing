<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Race to Housing</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:#111; }
    header { position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; z-index:10; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    #raceMap { width:100%; height:260px; background:#f6f8fa; border-radius:12px; border:1px solid #e5e7eb; display:flex; align-items:center; justify-content:center; font-weight:600; }
    .flex { display:flex; gap:16px; flex-wrap:wrap; }
    .card { flex:1 1 360px; border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:#fff; }
    .card h2 { margin:0 0 8px 0; font-size:18px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; }
    button { margin-top:12px; padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; font-weight:600; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .muted { color:#6b7280; font-size:13px; }
    .success { color:#065f46; }
    .error { color:#991b1b; }
    .leaderboard { width:100%; border-collapse:collapse; }
    .leaderboard th, .leaderboard td { border-bottom:1px solid #eee; padding:8px 6px; text-align:left; }
    .you { background:#fef9c3; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; color:#374151; }
    nav a { color:#111; text-decoration:none; font-weight:600; }
    nav a:hover { text-decoration:underline; }
    .row { display:flex; gap:8px; align-items:center; }
    .small { font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
      <div class="row">
        <h1 style="font-size:20px; margin:0;">Race to Housing</h1>
        <span class="pill">YSU Housing & Residence Life</span>
      </div>
      <nav><a href="#instructions">Instructions</a></nav>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px;">
    <!-- MAP AT TOP -->
    <div id="raceMap">Race Map (placeholder) — your route renders here</div>

    <div class="flex" style="margin-top:16px;">
      <!-- REDEEM CARD -->
      <section class="card" id="redeem-section">
        <h2>Redeem a Code</h2>
        <p class="muted small">Enter your Player ID and a promo/event code. Your progress is saved and will persist after refresh.</p>

        <label for="playerId">Player ID</label>
        <input id="playerId" placeholder="Enter your Player ID" autocomplete="off"/>

        <div class="row">
          <button id="loadPlayerBtn" title="Load current score for this Player ID">Load Player</button>
          <div id="currentPoints" class="muted">Points: —</div>
        </div>

        <label for="promoCode">Promo Code</label>
        <input id="promoCode" placeholder="Enter your code" autocomplete="off"/>

        <button id="applyBtn">Apply Code</button>
        <div id="redeemMessage" class="muted" style="margin-top:8px;"></div>

        <p class="muted small" style="margin-top:12px;">
          Tip: Keep your Player ID secret. Each unique code can only be used once per player.
        </p>
      </section>

      <!-- LEADERBOARD CARD -->
      <section class="card">
        <h2>Leaderboard (Top 20)</h2>
        <table class="leaderboard" id="leaderboardTable">
          <thead>
            <tr><th>#</th><th>Player</th><th>Points</th></tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr><td colspan="3" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- INSTRUCTIONS -->
    <section class="card" id="instructions" style="margin-top:16px;">
      <h2>Instructions</h2>
      <p class="muted">Coming soon.</p>
    </section>
  </main>

  <!-- Firebase + App Logic -->
  <script type="module">
    // ----------------------------
    // Firebase SDK (Modular)
    // ----------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, runTransaction,
      collection, query, orderBy, limit, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 1) FILL THIS IN WITH YOUR PROJECT CONFIG
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ----------------------------
    // DOM
    // ----------------------------
    const playerIdInput = document.getElementById("playerId");
    const promoCodeInput = document.getElementById("promoCode");
    const applyBtn = document.getElementById("applyBtn");
    const loadPlayerBtn = document.getElementById("loadPlayerBtn");
    const redeemMessage = document.getElementById("redeemMessage");
    const currentPointsEl = document.getElementById("currentPoints");
    const leaderboardBody = document.getElementById("leaderboardBody");

    // ----------------------------
    // Helpers
    // ----------------------------
    const LS_KEY_PREFIX = "rth_points_"; // localStorage mirror

    function setMessage(text, type="") {
      redeemMessage.className = type ? type : "muted";
      redeemMessage.textContent = text;
    }

    function safeCodeId(raw) {
      // Normalize code IDs (e.g., uppercase, trim spaces)
      return (raw || "").trim().toUpperCase();
    }

    function localCachePoints(playerId, points) {
      try {
        localStorage.setItem(LS_KEY_PREFIX + playerId, String(points));
      } catch (_) {}
    }

    function getCachedPoints(playerId) {
      try {
        const v = localStorage.getItem(LS_KEY_PREFIX + playerId);
        return v ? parseInt(v, 10) : null;
      } catch (_) {
        return null;
      }
    }

    async function loadPlayerPoints(playerId) {
      if (!playerId) return null;
      // 1) try cache
      const cached = getCachedPoints(playerId);
      if (cached !== null) {
        updatePointsUI(cached);
      }
      // 2) load from Firestore (source of truth)
      const pRef = doc(db, "penguins", playerId);
      const snap = await getDoc(pRef);
      if (snap.exists()) {
        const data = snap.data();
        const pts = Number(data.points || 0);
        localCachePoints(playerId, pts);
        updatePointsUI(pts);
        return pts;
      } else {
        // initialize on first see (0 points)
        await setDoc(pRef, { points: 0, lastUpdated: serverTimestamp() }, { merge: true });
        localCachePoints(playerId, 0);
        updatePointsUI(0);
        return 0;
      }
    }

    function updatePointsUI(points) {
      currentPointsEl.textContent = `Points: ${points}`;
    }

    async function refreshLeaderboard(highlightId = "") {
      const q = query(collection(db, "penguins"), orderBy("points", "desc"), limit(20));
      const snap = await getDocs(q);
      let rank = 0;
      let html = "";
      snap.forEach(docSnap => {
        rank++;
        const data = docSnap.data();
        const pid = docSnap.id;
        const nick = data.nickname || pid;
        const pts = Number(data.points || 0);
        const isYou = highlightId && (pid === highlightId);
        html += `
          <tr class="${isYou ? "you": ""}">
            <td>${rank}</td>
            <td>${nick}${isYou ? " (you)" : ""}</td>
            <td>${pts}</td>
          </tr>`;
      });
      if (!html) {
        html = `<tr><td colspan="3" class="muted">No players yet.</td></tr>`;
      }
      leaderboardBody.innerHTML = html;
    }

    // ----------------------------
    // Redemption Logic (one-claim-per-user-per-code)
    // ----------------------------
    async function applyCode() {
      const playerId = (playerIdInput.value || "").trim();
      const rawCode = (promoCodeInput.value || "").trim();
      const codeId = safeCodeId(rawCode);

      if (!playerId || !codeId) {
        setMessage("Please enter both your Player ID and a code.", "error");
        return;
      }

      applyBtn.disabled = true;
      setMessage("Checking code…");

      try {
        const codeRef = doc(db, "codes", codeId);
        const playerRef = doc(db, "penguins", playerId);
        const claimId = `${playerId}_${codeId}`;
        const claimRef = doc(db, "claims", claimId);

        await runTransaction(db, async (tx) => {
          const [codeSnap, playerSnap, claimSnap] = await Promise.all([
            tx.get(codeRef),
            tx.get(playerRef),
            tx.get(claimRef)
          ]);

          if (!codeSnap.exists()) {
            throw new Error("Invalid code.");
          }

          const code = codeSnap.data();
          const now = new Date();

          // Active window check (timestamps stored as Firestore Timestamps)
          if (code.activeFrom?.toDate && now < code.activeFrom.toDate()) {
            throw new Error("This code is not active yet.");
          }
          if (code.activeTo?.toDate && now > code.activeTo.toDate()) {
            throw new Error("This code has expired.");
          }

          // One claim per user per code
          if (claimSnap.exists()) {
            throw new Error("You’ve already used this code.");
          }

          const pts = Number(code.points || 0);
          if (!playerSnap.exists()) {
            tx.set(playerRef, { points: 0, lastUpdated: serverTimestamp() }, { merge: true });
          }

          // Update player points
          const currentPts = playerSnap.exists() ? Number(playerSnap.data().points || 0) : 0;
          const newPts = currentPts + pts;

          tx.update(playerRef, { points: newPts, lastUpdated: serverTimestamp() });

          // Write claim doc to block reuse
          tx.set(claimRef, {
            playerId,
            codeId,
            pointsAwarded: pts,
            label: code.label || null,
            claimedAt: serverTimestamp()
          });
        });

        // After commit, refresh UI
        const updated = await loadPlayerPoints(playerId);
        await refreshLeaderboard(playerId);

        setMessage(`✅ Code applied! Your new total is ${updated} points.`, "success");
        promoCodeInput.value = "";
      } catch (err) {
        console.error(err);
        setMessage(err.message || "Sorry, something went wrong applying that code.", "error");
      } finally {
        applyBtn.disabled = false;
      }
    }

    // ----------------------------
    // Wire up UI
    // ----------------------------
    loadPlayerBtn.addEventListener("click", async () => {
      const pid = (playerIdInput.value || "").trim();
      if (!pid) {
        setMessage("Enter your Player ID first.", "error");
        return;
      }
      setMessage("");
      await loadPlayerPoints(pid);
      await refreshLeaderboard(pid);
    });

    applyBtn.addEventListener("click", applyCode);

    // Auto-load last used player from localStorage key (optional QoL)
    (function tryAutoload() {
      // Scan localStorage for any rth_points_* keys and prefill last one used
      try {
        const keys = Object.keys(localStorage).filter(k => k.startsWith(LS_KEY_PREFIX));
        if (keys.length) {
          // pick the most recently modified by reading them (order not guaranteed; this is best-effort)
          const lastKey = keys.sort().slice(-1)[0];
          const pid = lastKey.replace(LS_KEY_PREFIX, "");
          playerIdInput.value = pid;
          loadPlayerPoints(pid);
          refreshLeaderboard(pid);
        } else {
          refreshLeaderboard(""); // still show something
        }
      } catch {
        refreshLeaderboard("");
      }
    })();

    // ----------------------------
    // MAP PLACEHOLDER
    // Replace with actual map/route rendering that reads player points and maps to polyline
    // ----------------------------
    const raceMap = document.getElementById("raceMap");
    raceMap.addEventListener("click", () => {
      alert("Map placeholder. Hook in your polyline rendering here.");
    });
  </script>
</body>
</html>
