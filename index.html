<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- If you already set your token elsewhere, you can also put it here -->
  <meta name="mapbox-token" content="">
  <title>Race to Housing — Auto‑Capture (7/7) Buildings</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display:grid; grid-template-rows:auto auto 1fr; height:100%; }
    header { display:flex; gap:12px; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb; background:#fff; position:sticky; top:0; z-index:3; }
    .badge { padding:4px 8px; border-radius:999px; background:#f3f4f6; font-weight:600; }
    #status { font-variant-numeric: tabular-nums; }
    .controls { margin-left:auto; display:flex; gap:8px; }
    button { border:1px solid #d1d5db; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .note { font-size:12px; color:#6b7280; }
    #diag { border-bottom:1px solid #e5e7eb; background:#fafafa; padding:8px 12px; font:12px/1.35 system-ui,-apple-system,Segoe UI; white-space:pre-wrap; }
    #map { position:relative; }
    #map, #map canvas { width:100%; height:100%; display:block; }
    .toast { position:absolute; left:12px; bottom:12px; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; box-shadow:0 8px 20px rgba(0,0,0,.2); z-index:5; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <span class="badge">YSU — Auto‑Capture</span>
    <strong id="status">0/7 captured</strong>
    <span class="note">(No prompts. Uses your existing token sources automatically.)</span>
    <div class="controls">
      <button id="startBtn">Start Auto‑Capture</button>
      <button id="downloadBtn" disabled>Download ysu_race_buildings_exact.geojson</button>
    </div>
  </header>

  <div id="diag">Diagnostics not run yet.</div>
  <div id="map"></div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
// =====================================
// TOKEN DISCOVERY (no UI prompts)
// Priority: window.MAPBOX_ACCESS_TOKEN → window.MAPBOX_TOKEN → ?token= → <meta name="mapbox-token">
// =====================================
(function(){
  const q = new URL(location.href).searchParams;
  const meta = document.querySelector('meta[name="mapbox-token"]');
  const discovered = window.MAPBOX_ACCESS_TOKEN || window.MAPBOX_TOKEN || q.get('token') || q.get('mbtoken') || q.get('access_token') || (meta && meta.content) || '';
  mapboxgl.accessToken = discovered; // may be empty; we'll diagnose below
})();

// =====================================
// CONFIG
// =====================================
const STYLE = 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q';
const INITIAL_VIEW = { center: [-80.644685, 41.107524], zoom: 17.2, pitch: 60, bearing: -133.6 };
const BUILDING_CENTERS = [
  { key:'lyden',      name:'Lyden House',                 lng:-80.64783, lat:41.10696 },
  { key:'cafaro',     name:'Cafaro House (incl. Annex)',  lng:-80.64897, lat:41.10754 },
  { key:'christman',  name:'Christman Dining',            lng:-80.64654, lat:41.10759 },
  { key:'weller',     name:'Weller House',                lng:-80.64628, lat:41.10849 },
  { key:'wick',       name:'Wick House',                  lng:-80.64533, lat:41.10869 },
  { key:'kilcawley',  name:'Kilcawley House',             lng:-80.64563, lat:41.10675 },
  { key:'courtyards', name:'University Courtyards',       lng:-80.65123, lat:41.10338 }
];

let map, candidateLayers = [], captured = [];
const els = {
  startBtn: document.getElementById('startBtn'),
  downloadBtn: document.getElementById('downloadBtn'),
  status: document.getElementById('status'),
  toast: document.getElementById('toast'),
  diag: document.getElementById('diag')
};

function toast(msg, ms=2000){
  els.toast.textContent = msg; els.toast.style.display='block';
  clearTimeout(els.toast._t); els.toast._t = setTimeout(()=> els.toast.style.display='none', ms);
}

// =====================================
// PRE‑INIT DIAGNOSTICS ("test cases")
// =====================================
async function runDiagnostics(){
  const token = mapboxgl.accessToken || '';
  const tests = [];
  tests.push({ name:'Token present', pass: !!token, info: token ? 'Provided' : 'Missing' });
  tests.push({ name:'Token format', pass: token.startsWith('pk.') || token.startsWith('sk.') || token.length>60, info: token ? 'Looks OK' : 'N/A' });

  // Try fetching the style directly so we can show a specific error instead of a blank map
  let styleOk=false, status='Not checked';
  if (token){
    try{
      const u = `https://api.mapbox.com/styles/v1/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q?access_token=${encodeURIComponent(token)}`;
      const r = await fetch(u, { method:'GET', mode:'cors' });
      styleOk = r.ok;
      status = r.ok ? `OK (${r.status})` : `HTTP ${r.status}`;
    }catch(e){ styleOk=false; status = e && e.message ? e.message : 'Network error'; }
  }
  tests.push({ name:'Style reachable', pass: styleOk, info: status });

  els.diag.innerHTML = tests.map(t=>`• <b>${t.name}</b>: ${t.pass?'✅':'❌'} — ${t.info}`).join('\n');
  return tests.every(t=>t.pass || t.name==='Token format');
}

// =====================================
// MAP + CAPTURE
// =====================================
const BUILDING_LAYER_PREDICATE = (layer) => {
  if (!layer) return false; const id = String(layer.id||'').toLowerCase();
  return (layer.type==='fill'||layer.type==='fill-extrusion') && (id.includes('building')||id.includes('bldg'));
};

function metersToPixelsAtLat(m, lat, z){
  const C=40075017, rad=lat*Math.PI/180; return m/(C*Math.cos(rad)/Math.pow(2,z));
}
function bboxAround([lng,lat], m, z){
  const px = metersToPixelsAtLat(m, lat, z), p = map.project([lng,lat]);
  const sw = map.unproject([p.x-px, p.y+px]); const ne = map.unproject([p.x+px, p.y-px]);
  return [sw.lng, sw.lat, ne.lng, ne.lat];
}
function layerIds(){ return candidateLayers.length ? candidateLayers : (candidateLayers=(map.getStyle().layers||[]).filter(BUILDING_LAYER_PREDICATE).map(l=>l.id)); }
function queryBuildingsInBox(box){
  const feats = map.queryRenderedFeatures(box, { layers: layerIds() });
  return feats.filter(f=>f.geometry && (f.geometry.type==='Polygon'||f.geometry.type==='MultiPolygon'));
}
function dissolve(features){
  if (!features.length) return null; const fc=turf.featureCollection(features.map(f=>turf.clone(f)));
  try{ let u=fc.features[0]; for(let i=1;i<fc.features.length;i++) u=turf.union(u, fc.features[i]); return u; }
  catch(_){ return turf.combine(fc); }
}
async function flyAndIdle(opts){ return new Promise(res=>{ const done=()=>{ map.off('idle',done); res(); }; map.once('idle',done); map.flyTo({ ...opts, duration:700 }); }); }
async function captureOne(target, attempt=1){
  const radii=[28,42,60,85], radius=radii[Math.min(attempt-1,radii.length-1)];
  await flyAndIdle({ center:[target.lng,target.lat], zoom:Math.max(INITIAL_VIEW.zoom,17.2), pitch:INITIAL_VIEW.pitch, bearing:INITIAL_VIEW.bearing });
  const feats = queryBuildingsInBox(bboxAround([target.lng,target.lat], radius, map.getZoom()));
  if (!feats.length){ if (attempt<4) { toast(`No features at ${target.name} (try ${attempt+1}/4) — widening…`); return captureOne(target, attempt+1); }
    throw new Error(`No building polygons found for ${target.name}`); }
  const merged=dissolve(feats); if(!merged) throw new Error(`Could not merge features for ${target.name}.`);
  const fixed=turf.truncate(merged,{ precision:6, coordinates:3 }); fixed.properties={ name:target.name, key:target.key }; return fixed;
}
function updateStatus(){ els.status.textContent = `${captured.length}/7 captured`; if(captured.length===BUILDING_CENTERS.length){ els.downloadBtn.disabled=false; toast('All 7 captured — ready to download'); } }
function downloadGeoJSON(){ const fc={ type:'FeatureCollection', features:captured }; const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ysu_race_buildings_exact.geojson'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),2000); }
els.downloadBtn.addEventListener('click', downloadGeoJSON);

async function runAutoCapture(){
  els.downloadBtn.disabled=true; captured=[]; updateStatus(); toast('Starting auto‑capture…');
  for (const target of BUILDING_CENTERS){ try{ const feat=await captureOne(target); captured.push(feat); updateStatus(); }catch(e){ console.error(e); toast(e.message,2400); } }
  if (captured.length<BUILDING_CENTERS.length){ toast(`Captured ${captured.length}/7. Adjust centers if needed and run again.`,2600); return; }
  try{ const fc={type:'FeatureCollection',features:captured}; if(!map.getSource('captured')){ map.addSource('captured',{type:'geojson',data:fc}); map.addLayer({id:'captured-fill',type:'fill',source:'captured',paint:{'fill-opacity':0.35}}); map.addLayer({id:'captured-outline',type:'line',source:'captured',paint:{'line-width':2}}); map.addLayer({id:'captured-labels',type:'symbol',source:'captured',layout:{'text-field':['get','name'],'text-size':12,'text-offset':[0,1.2]},paint:{'text-halo-width':1,'text-halo-color':'#ffffff'}}); } else { map.getSource('captured').setData(fc); } }catch(e){ console.warn('Render overlay failed',e); }
}

// =====================================
// BOOT: run diagnostics, then init the map (no user interaction)
// =====================================
(async function boot(){
  const ok = await runDiagnostics();
  if (!ok){ toast('Token/style issue detected — see diagnostics above.'); }
  // Initialize map regardless, but show on‑screen errors if Mapbox complains
  map = new mapboxgl.Map({ container:'map', style:STYLE, ...INITIAL_VIEW });
  map.addControl(new mapboxgl.NavigationControl({ showZoom:true }), 'top-right');
  map.on('error', (e)=>{ console.error('Mapbox GL error', e && e.error); toast('Map error: ' + (e && e.error && e.error.message ? e.error.message : 'see console')); });
  map.on('load', ()=>{
    candidateLayers = (map.getStyle().layers || []).filter(BUILDING_LAYER_PREDICATE).map(l=>l.id);
    if (!candidateLayers.length){ toast('Heads‑up: no obvious building layers found in style.'); }
  });
})();

document.getElementById('startBtn').addEventListener('click', runAutoCapture);
</script>
</body>
</html>
