<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Race to Housing â€” Campus Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html,body{height:100%;margin:0}
    #map{position:absolute;inset:0}
    /* subtle UI for errors */
    .toast{
      position:absolute;left:12px;bottom:12px;z-index:10;
      background:#111827;color:#fff;border-radius:10px;padding:8px 12px;
      font:13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      box-shadow:0 10px 24px rgba(0,0,0,.18);max-width:min(560px,92vw)
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="toast" class="toast" style="display:none;"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <script>
    // ========= CONFIG =========
    mapboxgl.accessToken =
      'pk.eyJ1IjoieXN1LWhybCIsImEiOiJjbWZtcjVkNXUwNTJkMmxvaDZpaTF6b2x2In0.8-4W7BoAy5GmwM2_-L_Jzw';

    // Your saved exact footprints file (already in the repo)
    const BUILDINGS_GEOJSON_URL = 'ysu_race_buildings_exact.geojson';

    // Logo image in your repo (transparent PNG). Replace with your actual filename if different.
    const LOGO_URL   = 'ysu_housing_logo.png';   // e.g. 'ysu_housing_logo.png'
    const LOGO_SIZE  = 0.0009; // roughly controls icon size via "icon-size" (tweak if needed)
    const LOGO_POINT = [-80.6459, 41.1096]; // where the logo sits on the map (tweak if needed)

    // Default opening view (the oblique angle you liked)
    const VIEW = {
      center: [-80.644685, 41.107524],
      zoom:   17.2,
      pitch:  60,
      bearing:-133.6,
      minZoom:15,
      maxZoom:20
    };

    // ========= MAP =========
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/ysu-hrl/cmfpr50qm00a401ry0uzb5b1q',
      center: VIEW.center,
      zoom:   VIEW.zoom,
      pitch:  VIEW.pitch,
      bearing:VIEW.bearing,
      minZoom: VIEW.minZoom,
      maxZoom: VIEW.maxZoom
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    function toast(txt){
      const el = document.getElementById('toast');
      el.textContent = txt;
      el.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ el.style.display='none'; }, 4000);
    }

    // Hide default text labels so only our building labels show
    function hideBaseLabels(){
      const layers = map.getStyle().layers || [];
      for (const l of layers){
        if (l.type === 'symbol' || /label/i.test(l.id)){
          try{ map.setLayoutProperty(l.id, 'visibility', 'none'); }catch(e){}
        }
      }
    }

    map.on('styledata', hideBaseLabels);

    map.on('load', async () => {
      hideBaseLabels();

      // ---- 1) Load saved footprints ----
      let data;
      try{
        const r = await fetch(BUILDINGS_GEOJSON_URL, { cache:'no-store' });
        if(!r.ok) throw new Error('not found');
        data = await r.json();
      }catch(e){
        toast('Could not load "ysu_race_buildings_exact.geojson". Make sure it is in the repo root.');
        return;
      }

      // Ensure minimal properties exist (height, fill)
      for (const f of (data.features||[])){
        if (!f.properties) f.properties = {};
        if (f.properties.type !== 'building') f.properties.type = 'building';
        if (typeof f.properties.height !== 'number') f.properties.height = 22;
        if (!f.properties.fill) f.properties.fill = '#d32f2f';
      }

      // ---- 2) Source + layers for 3D buildings ----
      map.addSource('race-buildings', { type:'geojson', data });

      // thin outline under the extrusion (helps edges read)
      map.addLayer({
        id:'race-buildings-outline',
        type:'line',
        source:'race-buildings',
        filter:['==',['get','type'],'building'],
        paint:{
          'line-color':'#263238',
          'line-width': 0.6,
          'line-opacity': 0.35
        }
      });

      map.addLayer({
        id:'race-buildings-3d',
        type:'fill-extrusion',
        source:'race-buildings',
        filter:['==',['get','type'],'building'],
        paint:{
          'fill-extrusion-color': ['get','fill'],
          'fill-extrusion-height':['coalesce',['get','height'],22],
          'fill-extrusion-opacity': 0.96
        }
      });

      // ---- 3) Labels for each building (uses feature centroid automatically) ----
      map.addLayer({
        id:'race-buildings-labels',
        type:'symbol',
        source:'race-buildings',
        filter:['==',['get','type'],'building'],
        layout:{
          'text-field': ['get','name'],
          'text-size': 13,
          'text-allow-overlap': false,
          'text-anchor': 'center',
          'text-justify':'center',
          'text-font': ['Open Sans Semibold','Arial Unicode MS Bold'],
          'symbol-sort-key': 1
        },
        paint:{
          'text-color': '#111',
          'text-halo-color': '#ffffff',
          'text-halo-width': 1.5,
          'text-opacity': 0.95
        }
      });

      // ---- 4) Add the YSU Housing logo as a symbol point ----
      try {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          // register image and add a point for it
          if (!map.hasImage('ysu-logo')) map.addImage('ysu-logo', img, { sdf:false });
          map.addSource('ysu-logo-src', {
            type:'geojson',
            data: {
              type:'FeatureCollection',
              features:[{ type:'Feature', properties:{}, geometry:{ type:'Point', coordinates: LOGO_POINT } }]
            }
          });
          map.addLayer({
            id:'ysu-logo-layer',
            type:'symbol',
            source:'ysu-logo-src',
            layout:{
              'icon-image': 'ysu-logo',
              'icon-size': LOGO_SIZE,
              'icon-allow-overlap': true,
              'icon-anchor': 'center'
            }
          });
        };
        img.onerror = () => { /* optional fallback */ console.warn('Logo image not found at', LOGO_URL); };
        img.src = LOGO_URL; // must exist in the repo (same folder as index.html)
      } catch(err){ console.warn(err); }

      toast('Loaded buildings & labels. (Logo appears if the image file exists.)');
    });
  </script>
</body>
</html>
